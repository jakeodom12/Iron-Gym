<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- SECURITY & PRIVACY -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://unpkg.com https://generativelanguage.googleapis.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:; connect-src 'self' https://generativelanguage.googleapis.com;">
    <meta name="referrer" content="no-referrer">
    <meta name="robots" content="noindex, nofollow, noarchive">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#09090b">
    <title>The Iron Garage</title>
    
    <!-- Tech Stack -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        zinc: { 850: '#1f1f22', 900: '#18181b', 950: '#09090b' },
                        iron: { red: '#dc2626', emerald: '#10b981', blue: '#3b82f6', amber: '#f59e0b', purple: '#8b5cf6', cyan: '#06b6d4', rose: '#e11d48' }
                    },
                    fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'] },
                    spacing: { 'safe-top': 'env(safe-area-inset-top)', 'safe-bottom': 'env(safe-area-inset-bottom)' }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; user-select: none; background-color: #09090b; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .tab-active { border-bottom: 2px solid #dc2626; color: #f4f4f5; }
        .tab-active-rebuild { border-bottom: 2px solid #10b981; color: #f4f4f5; }
        .tab-active-tonic { border-bottom: 2px solid #3b82f6; color: #f4f4f5; }
        .tab-active-ruck { border-bottom: 2px solid #f59e0b; color: #f4f4f5; }
        .tab-active-cond { border-bottom: 2px solid #e11d48; color: #f4f4f5; }
        .tab-active-history { border-bottom: 2px solid #8b5cf6; color: #f4f4f5; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #71717a; }
        
        .checkbox-wrapper input:checked + div { background-color: #dc2626; border-color: #dc2626; }
        .checkbox-wrapper input:checked + div svg { display: block; }
        
        .floating-timer { position: fixed; bottom: calc(env(safe-area-inset-bottom) + 80px); right: 20px; z-index: 50; }
        
        .chat-bubble { max-width: 85%; padding: 12px; border-radius: 12px; margin-bottom: 8px; font-size: 0.85rem; line-height: 1.4; }
        .chat-user { background-color: #27272a; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-ai { background-color: #dc2626; color: white; align-self: flex-start; border-bottom-left-radius: 2px; }
        
        .active-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-100 h-screen w-screen overflow-hidden flex flex-col font-sans">
    <div id="app" class="flex-1 flex flex-col h-full relative max-w-lg mx-auto border-x border-zinc-900"></div>

    <script>
    (function() {
        const VERSION = "2.02.00";
        const APP_BUILD_DATE = "Jan 14, 2026";
        const STORAGE_KEY = 'iron-garage-v2.02'; 
        const API_KEY_STORAGE = 'iron-garage-api-key';

        const KNOWLEDGE_BASE = `
            PHILOSOPHY: Dan John (Easy Strength, Armor Building) + Unified Hybrid Conditioning.
            NARRATIVES:
            1. UNIFIED FIELD THEORY: Concurrent training is mandatory. Vector-specific load matters (Sleds vs Squats). Interference effect is nuanced.
            2. KINETIC ROADMAP: Bridge 16kg->24kg jump via density. Asymmetrical load demands anti-rotation core stability.
            3. ARCHITECTURE OF ADAPTATION: SAID Principle. Barbells = Systemic Load. Dumbbells = ROM & Unilateral Stability.
            4. ORIGINAL STRENGTH: Tonic resets restore reflexive stability.
        `;

        const INVENTORY = { kbs: { pairs: [20, 24, 32], singles: [28, 44] }, barbell: true, machines: ['Assault Runner', 'Reverse Hyper', 'Pull-up Bar', 'Sled', 'Sandbag'] };

        const WORKOUTS = {
            grind: [
                { id: 'es-classic', title: 'Easy Strength Classic', desc: '40-day cycle. Never miss a rep.', equipment: 'Barbell', difficulty: 'beginner', protocol: '2x5. Leave fresh.', movements: ['DL/Swing (2x5)', 'Press/Bench (2x5)', 'Pull-up/Row (2x5)', 'Front Sq (2x5)', 'Farmer Walk'], rounds: 1 },
                { id: 'abf-press-ladders', title: 'ABF Press Ladders', desc: 'Heavy pressing volume.', equipment: 'Double KBs', difficulty: 'intermediate', protocol: 'Ladders of 2, 3, 5. Perform 3-5 total ladders.', movements: ['Double Clean & Press Ladders', 'Pull-ups (Match sets)', 'Goblet Squats (Flush)'], rounds: 5 },
                { id: 'architect-ppl', title: 'The Architect PPL', desc: 'Hypertrophy split.', equipment: 'Barbell/DB', difficulty: 'intermediate', protocol: '3x8-12. Focused tension.', movements: ['Push: Bench, DB Incline, Lat Raise', 'Pull: Row, Pull-ups, Curls', 'Legs: Squat, RDL, Lunges'], rounds: 1 },
                { id: 'db-symmetry', title: 'DB Symmetry Split', desc: 'Unilateral focus.', equipment: 'Dumbbells', difficulty: 'beginner', protocol: '3x12. Balance focus.', movements: ['Upper: Bench, Row, Press', 'Lower: Goblet Sq, DB RDL, Step-ups'], rounds: 1 },
                { id: 'said-strength', title: 'SAID Protocol', desc: 'Neural drive.', equipment: 'Barbell', difficulty: 'advanced', protocol: '3x3 @ 85%+. Long rest.', movements: ['Back Squat', 'Bench Press', 'Deadlift'], rounds: 1 },
                { id: 'dfw', title: 'Dry Fighting Weight', desc: 'KB strength staple.', equipment: 'Double KBs', difficulty: 'advanced', protocol: '30m Density. C&P + Squats.', movements: ['Clean & Press (Ladders)', 'Front Squat (Ladders)'], rounds: 1 },
                { id: 'reg-park-5x5', title: 'Reg Park 5x5', desc: 'Classics.', equipment: 'Barbell', difficulty: 'beginner', protocol: '3x5 work sets.', movements: ['Back Squat', 'Chin-ups', 'Deadlift'], rounds: 1 },
                { id: 'bb-emom-foundation', title: 'Strength EMOM 1', desc: 'Foundation.', equipment: 'Barbell', protocol: 'M1: 8 DL, M2: 8 Press, M3: 8 FSQ, M4: Rest.', movements: ['Hinge', 'Push', 'Squat'], rounds: 6, difficulty: 'intermediate' },
                { id: 'bb-emom-hinge', title: 'Strength EMOM 2', desc: 'Hinge focus.', equipment: 'Barbell', protocol: 'Odd: 3 Clean+3 FSQ, Even: 8 RDL.', movements: ['Hinge/Power'], rounds: 7, difficulty: 'advanced' },
                { id: 'bb-emom-pump', title: 'Strength EMOM 3', desc: 'Upper pump.', equipment: 'Bar/DB', protocol: 'Odd: 10 Bench, Even: 12 Rows.', movements: ['Press', 'Pull'], rounds: 8, difficulty: 'intermediate' },
                { id: 'bb-emom-couplet', title: 'Strength EMOM 4', desc: 'Hinge/Push.', equipment: 'Barbell', protocol: '5 DL + 8 HR Pushups.', movements: ['Compound'], rounds: 15, difficulty: 'intermediate' },
                { id: 'bb-emom-flow', title: 'Strength EMOM 5', desc: 'Complex flow.', equipment: 'Barbell', protocol: '1 Complex per minute.', movements: ['Complex'], rounds: 10, difficulty: 'advanced' },
                ...Array.from({length: 8}).map((_,i)=>({ id: `grind-extra-${i}`, title: `Strength Grind #${i+6}`, desc: 'Roadmap protocol.', equipment: 'Barbell/DB', difficulty: 'intermediate', protocol: 'Varies.', movements: ['Compound Lifts'], rounds: 1 }))
            ],
            ballistic: [
                { id: 'deep-six', title: 'The Deep Six', desc: 'KB flow sequence.', equipment: 'Single KB', difficulty: 'advanced', protocol: '5 Rounds. No setting bell down.', movements: ['Swing x5', 'Snatch x5', 'C&P x5', 'Front Sq x5', 'Lunge x5/side', 'TGU x1'], rounds: 5 },
                { id: '10k-swings', title: '10,000 Swings Block', desc: 'Volume.', equipment: 'Kettlebell', difficulty: 'advanced', protocol: '500 Swings in clusters.', movements: ['10-15-25-50 Cluster', 'Strength Reps'], rounds: 5 },
                { id: 'humane-burpee', title: 'Humane Burpee', desc: 'Descending volume.', equipment: 'Kettlebell', difficulty: 'intermediate', protocol: '15 Swings, 5-4-3-2-1 Sq/Push.', movements: ['KB Swings', 'Goblet Squats', 'Pushups'], rounds: 5 },
                { id: 'hill-contrast', title: 'Hill/Aerobic Contrast', desc: 'Power development.', equipment: 'Hill', difficulty: 'intermediate', protocol: 'Sprint up, walk down.', movements: ['10s Sprint', 'Recovery Walk'], rounds: 10 },
                { id: 'plyo-speed', title: 'Plyo Speed Circuit', desc: 'Ground force.', equipment: 'Box', difficulty: 'advanced', protocol: 'Max effort reps.', movements: ['Box Jumps', 'Ball Slams', 'Broad Jumps'], rounds: 4 },
                { id: 'sq-snatch-emom', title: 'Squat & Snatch EMOM', desc: 'Odds/Evens.', equipment: 'Single DB', protocol: 'Odd:14 Snatches, Even:12 Goblet Sq.', movements: ['Snatch', 'Squat'], rounds: 8, difficulty: 'intermediate' },
                { id: 'cardio-clean-emom', title: 'KB Cardio EMOM', desc: 'HR Focus.', equipment: 'Single KB', protocol: 'Odd:20 Swings, Even:10 Burpees.', movements: ['Swing', 'Burpee'], rounds: 9, difficulty: 'intermediate' },
                { id: 'turnover-200', title: '200m Turnover', desc: 'Speed maintenance.', equipment: 'Track', difficulty: 'advanced', protocol: '200m @ 90%. 90s rest.', movements: ['Sprints'], rounds: 10 },
                ...Array.from({length: 12}).map((_,i)=>({ id: `ballistic-extra-${i}`, title: `Ballistic Gasser #${i+9}`, desc: 'Speed protocol.', equipment: 'KB/Runner', difficulty: 'intermediate', protocol: 'Varies.', movements: ['Ballistic Work'], rounds: 5 }))
            ],
            hybrid: [
                { id: 'abc-single-complex', title: 'Single KB ABC', desc: 'Asymmetrical armor.', equipment: 'Single KB', difficulty: 'intermediate', protocol: 'L: 1 Clean, 1 Press, 3 Squats. R: Same. Repeat.', movements: ['Clean & Press (L)', 'Clean & Press (R)', 'Front Squats'], rounds: 10 },
                { id: 'abc-double', title: 'Armor Building Complex', desc: '2 Clean, 1 Press, 3 Squat.', equipment: 'Double KBs', difficulty: 'intermediate', protocol: 'EMOM 20-30 mins.', movements: ['Clean', 'Press', 'Front Squat'], rounds: 20 },
                { id: 'olympic-3', title: 'The Olympic 3.0', desc: 'Fat loss complex.', equipment: 'Double KBs', difficulty: 'advanced', protocol: 'Non-stop complex.', movements: ['Double Clean', 'Double Press', 'Double Squat'], rounds: 10 },
                { id: 'killer-farmer', title: 'Killer Farmer\'s Walk', desc: 'Grip grit.', equipment: 'Heavy Weights', difficulty: 'advanced', protocol: '5m Max distance.', movements: ['Carry/Rest cycle'], rounds: 1 },
                { id: 'man-maker-emom', title: 'Man-Maker Punisher', desc: 'Bodyweight/DB grind.', equipment: 'Pair DBs', difficulty: 'advanced', protocol: '3-4 reps every min.', movements: ['Man Makers'], rounds: 10 },
                { id: 'db-classic-emom', title: 'DB Classic EMOM', desc: 'Full body rotating.', equipment: 'Pair DBs', protocol: 'M1:12 Thruster, M2:12 Row, M3:15 Sq, M4:12 Burpee.', movements: ['Thrusters', 'Rows'], rounds: 5, difficulty: 'intermediate' },
                { id: 'kb-flow-emom', title: 'KB Flow EMOM', desc: 'Unilateral flow.', equipment: 'Single KB', protocol: '4 min cycle focus.', movements: ['C&P', 'Swings', 'Lunges'], rounds: 5, difficulty: 'intermediate' },
                { id: 'unilateral-emom', title: 'Unilateral Stability EMOM', desc: 'Anti-rotation.', equipment: 'Single DB/KB', protocol: '4 min cycle.', movements: ['SL RDL', 'SA Press'], rounds: 5, difficulty: 'intermediate' },
                { id: 'sparhawk', title: 'The Sparhawk', desc: 'Density carries.', equipment: 'Single KB', difficulty: 'intermediate', protocol: '8->1 ladder.', movements: ['Goblet Sq', 'Suitcase Carry'], rounds: 8 },
                { id: 'bear-bear', title: 'Bear / Bear', desc: 'Collision strength.', equipment: 'Sandbag', difficulty: 'intermediate', protocol: 'Crawl/Carry.', movements: ['Bear Crawl', 'Bearhug Carry'], rounds: 5 },
                ...Array.from({length: 10}).map((_,i)=>({ id: `hybrid-extra-${i}`, title: `Hybrid Mixer #${i+11}`, desc: 'Roadmap protocol.', equipment: 'Various', difficulty: 'intermediate', protocol: 'Varies.', movements: ['Mixed Implements'], rounds: 5 }))
            ],
            conditioning: [
                { id: 'apex-grit', title: 'Apex of the World', desc: 'Sandbag/Hill grit.', equipment: 'Sandbag', difficulty: 'advanced', protocol: 'Carry up, run down.', movements: ['Bag power hike', 'Run down empty'], rounds: 4 },
                { id: 'hyrox-sled', title: 'Hyrox Sled Pull', desc: 'Strength endurance.', equipment: 'Sled', difficulty: 'advanced', protocol: '50m Pulls.', movements: ['Sled Pull (Heavy)'], rounds: 4 },
                { id: 'wattage-hunter', title: 'Peak Wattage Hunter', desc: 'Max power runner.', equipment: 'Assault Runner', difficulty: 'advanced', protocol: '10s Max / 3m Walk.', movements: ['Max Output Sprint'], rounds: 6 },
                { id: 'thruster-gasp-emom', title: 'Thruster Gasp EMOM', desc: 'METCON density.', equipment: 'DBs', difficulty: 'advanced', protocol: '5 Thrusters + 5 Burpees.', movements: ['Metabolic spike'], rounds: 10 },
                { id: 'death-by-emom', title: 'Death By EMOM', desc: 'Add 1 rep every min.', equipment: 'Bar/DB', difficulty: 'advanced', protocol: 'Fail EMOM.', movements: ['Thrusters'], rounds: 15 },
                { id: 'heavy-light-emom', title: 'Heavy/Light Toggle', desc: 'CNS focus.', equipment: 'Bar/Rope', difficulty: 'advanced', protocol: 'Odd:3 Heavy DL, Even:45s Rope.', movements: ['CNS Stim'], rounds: 8 },
                ...Array.from({length: 20}).map((_,i) => ({ id: `ar-p-${i+1}`, title: `Assault Runner #${i+1}`, desc: 'Speed roadmap.', difficulty: i % 2 === 0 ? 'intermediate' : 'advanced', equipment: 'Runner', protocol: 'Wattage intervals.', movements: ['Sprint/Walk'], rounds: 6 }))
            ],
            tonic: [
                { id: 'os-reset-std', title: 'OS Reset (Standard)', desc: 'Reflexive stability.', equipment: 'Floor', difficulty: 'beginner', protocol: '3-5 reps of each.', movements: ['Nods', 'Rocks', 'Rolls', 'Bear Crawl'], rounds: 1 },
                { id: 'os-performance', title: 'OS Performance Reset', desc: 'Tension clearing.', equipment: 'Floor', difficulty: 'beginner', protocol: 'Active rest.', movements: ['Upper Body Rocks', 'Spiderman Crawls'], rounds: 1 },
                { id: 'rolling-40', title: 'The Rolling 40', desc: 'Full restoration.', equipment: 'Roller', difficulty: 'beginner', protocol: '40m continuous.', movements: ['Foam Roll', 'Joint Mobilization'], rounds: 1 },
                { id: 'plenty-nothing', title: 'Plenty of Nothing', desc: 'Bodyweight knit.', equipment: 'Floor', difficulty: 'beginner', protocol: 'Quality focus.', movements: ['Pushups', 'Supermans', 'Hip Thrusts', 'Squats'], rounds: 3 },
                { id: 'eye-reset', title: 'Head & Eye Reset', desc: 'Neuro reset.', equipment: 'Floor', difficulty: 'beginner', protocol: 'Slow controlled nods.', movements: ['Eye tracking', 'Head nods'], rounds: 1 },
                { id: 'joint-lube', title: 'Joint Lubrication Flow', desc: 'Synovial fluid.', equipment: 'None', difficulty: 'beginner', protocol: 'Circular motions.', movements: ['Wrist/Ankle/Hip Circles'], rounds: 1 }
            ],
            ruck: [
                { id: 'ruck-1-5', title: '1.5 Miles (Reset)', desc: 'Morning reset.', equipment: 'Ruck', difficulty: 'beginner', protocol: 'Green light pace.', table: [ { load: '10lb', beginner: '30:00', moderate: '25:30', advanced: '22:30' }, { load: '20lb', beginner: '30:00', moderate: '25:30', advanced: '22:30' }, { load: '30lb', beginner: '30:00', moderate: '25:30', advanced: '22:30' }, { load: '45lb', beginner: '30:00', moderate: '25:30', advanced: '22:30' } ], movements: ['Posture Focus'], rounds: 1 },
                { id: 'ruck-3k', title: '3.0 KM (Standard)', desc: 'Tonic ruck.', equipment: 'Ruck', difficulty: 'intermediate', protocol: 'Zone 2 heart rate.', table: [ { load: '10lb', beginner: '37:00', moderate: '32:00', advanced: '28:00' }, { load: '20lb', beginner: '37:00', moderate: '32:00', advanced: '28:00' }, { load: '30lb', beginner: '37:00', moderate: '32:00', advanced: '28:00' }, { load: '45lb', beginner: '37:00', moderate: '32:00', advanced: '28:00' } ], movements: ['Steady Cadence'], rounds: 1 },
                { id: 'ruck-5k', title: '5.0 KM (Endurance)', desc: 'Training volume.', equipment: 'Ruck', difficulty: 'advanced', protocol: 'Monitor hotspots.', table: [ { load: '10lb', beginner: '1h 02m', moderate: '53:00', advanced: '46:30' }, { load: '20lb', beginner: '1h 02m', moderate: '53:00', advanced: '46:30' }, { load: '30lb', beginner: '1h 02m', moderate: '53:00', advanced: '46:30' }, { load: '45lb', beginner: '1h 02m', moderate: '53:00', advanced: '46:30' } ], movements: ['Hydration mandatory'], rounds: 1 },
                { id: 'ruck-5m', title: '5.0 Miles (Long)', desc: 'Weekend challenge.', equipment: 'Ruck', difficulty: 'advanced', protocol: 'Durability focus.', table: [ { load: '10lb', beginner: '1h 40m', moderate: '1h 25m', advanced: '1h 15m' }, { load: '20lb', beginner: '1h 40m', moderate: '1h 25m', advanced: '1h 15m' }, { load: '30lb', beginner: '1h 40m', moderate: '1h 25m', advanced: '1h 15m' }, { load: '45lb', beginner: '1h 40m', moderate: '1h 25m', advanced: '1h 15m' } ], movements: ['Steady Grind'], rounds: 1 }
            ],
            rebuild: [
                { id: 'reb-1', title: 'Week 1: Breath', movements: ['Meditation', 'OS Nods', 'Rocks', 'Amble Walk'], difficulty: 'beginner', equipment: 'Floor', desc: 'Phase 1: Reset.', protocol: 'Regulate system.', rounds: 1 },
                { id: 'reb-2', title: 'Week 2: Awake', movements: ['Hang 30s', 'Squat Hold', 'OS Rolls', 'Amble Walk'], difficulty: 'beginner', equipment: 'Floor', desc: 'Phase 1: Awake.', protocol: 'ROM Focus.', rounds: 1 },
                { id: 'reb-3', title: 'Week 3: Pattern', movements: ['Goblet Sq (Light)', 'Suitcase Carry', 'Amble Walk'], difficulty: 'beginner', equipment: 'KB', desc: 'Phase 1: Pattern.', protocol: 'Patterning.', rounds: 1 },
                { id: 'reb-4', title: 'Week 4: Integrity', movements: ['Goblet Sq x2', 'Carry x2', 'OS Egg Rolls', 'Walk'], difficulty: 'beginner', equipment: 'KB', desc: 'Phase 1: Checkpoint.', protocol: 'Volume test.', rounds: 1 },
                { id: 'reb-5', title: 'Week 5: Tension', movements: ['HK Press 3x3', 'Pull-up 3x3', 'Hip Thrust 3x10', 'Carry'], difficulty: 'beginner', equipment: 'KB', desc: 'Phase 2: Tension.', protocol: '3x3 Rule.', rounds: 1 },
                { id: 'reb-6', title: 'Week 6: Stability', movements: ['HK Press 3x3', 'Swing 3x10', 'Carry'], difficulty: 'beginner', equipment: 'KB', desc: 'Phase 2: Stability.', protocol: 'Fatigue management.', rounds: 1 },
                { id: 'reb-7', title: 'Week 7: Volume', movements: ['HK Press 2x5', 'Swing 2x15', 'Farmer Walk'], difficulty: 'intermediate', equipment: 'KB', desc: 'Phase 2: Volume.', protocol: 'Shift to 2x5.', rounds: 1 },
                { id: 'reb-8', title: 'Week 8: Capacity', movements: ['HK Press 2x5 (Load)', 'Goblet Sq 2x10', 'Carry'], difficulty: 'intermediate', equipment: 'KB', desc: 'Phase 2: Capacity.', protocol: 'Test strength.', rounds: 1 },
                { id: 'reb-9', title: 'Week 9: Return A', movements: ['[A] Press (8) + Hang (30s)', '[B] Swing (15) + Carry'], difficulty: 'intermediate', equipment: 'KB', desc: 'Phase 3: Integration.', protocol: 'Structural return.', rounds: 1 },
                { id: 'reb-10', title: 'Week 10: Density', movements: ['[A] Press (8) + Hang', '[B] FSQ (10) + Swing'], difficulty: 'intermediate', equipment: 'KB', desc: 'Phase 3: Density.', protocol: 'Min rest.', rounds: 1 },
                { id: 'reb-11', title: 'Week 11: Load', movements: ['[A] Heavy Press (5)', '[B] Swing (25)'], difficulty: 'intermediate', equipment: 'KB', desc: 'Phase 3: Load.', protocol: 'Heavier loads.', rounds: 1 },
                { id: 'reb-12', title: 'Week 12: Graduation', movements: ['[A] Press (5) + Pull (5)', '[B] Swing (25)'], difficulty: 'intermediate', equipment: 'KB', desc: 'Phase 3: Graduation.', protocol: 'Full Strength.', rounds: 1 }
            ]
        };

        const WARMUP_LIST = [
            { title: "1. Meditation", desc: "1-Min O.M.M. Count breaths." },
            { title: "2. Mobility", desc: "30s Bar Hang + 30s Goblet Squat Hold." },
            { title: "3. Compass", desc: "Work, Rest, Play, Pray review." },
            { title: "4. Warm-up Sets", desc: "1 light set: Press, Row, Hinge, Squat, Carry." }
        ];

        let state = { currentTab: 'grind', activeWorkout: null, checklists: {}, timer: 0, timerRunning: false, history: [], chatHistory: [], warmupActive: false, apiKey: localStorage.getItem(API_KEY_STORAGE) || '', ...loadState() };
        let timerInterval;

        function loadState() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch(e) { return {}; } }
        function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

        const Icons = {
            Home: '<i data-lucide="home" class="w-5 h-5"></i>', Dumbbell: '<i data-lucide="dumbbell" class="w-5 h-5"></i>', Zap: '<i data-lucide="zap" class="w-5 h-5"></i>', Activity: '<i data-lucide="activity" class="w-5 h-5"></i>', Shuffle: '<i data-lucide="shuffle" class="w-6 h-6"></i>', ChevronLeft: '<i data-lucide="chevron-left" class="w-5 h-5"></i>', Check: '<i data-lucide="check" class="w-4 h-4 text-white hidden"></i>', History: '<i data-lucide="clock" class="w-5 h-5"></i>', Timer: '<i data-lucide="timer" class="w-6 h-6"></i>', Sparkles: '<i data-lucide="sparkles" class="w-5 h-5"></i>', Send: '<i data-lucide="send" class="w-5 h-5"></i>', Lock: '<i data-lucide="lock" class="w-4 h-4"></i>', Gauge: '<i data-lucide="gauge" class="w-4 h-4"></i>', Trash: '<i data-lucide="trash-2" class="w-4 h-4"></i>', Save: '<i data-lucide="save" class="w-4 h-4"></i>', Flame: '<i data-lucide="flame" class="w-5 h-5"></i>'
        };

        window.APP = {
            switchTab: (t) => { state.currentTab = t; state.warmupActive = false; saveState(); render(); },
            toggleWarmup: () => { state.warmupActive = !state.warmupActive; render(); },
            exitWorkout: () => { state.activeWorkout = null; state.checklists = {}; state.timerRunning = false; clearInterval(timerInterval); saveState(); render(); },
            completeWorkout: () => { if(confirm('Log session?')) { state.history.push({ name: state.activeWorkout.title, date: new Date().toISOString() }); APP.exitWorkout(); } },
            toggleRound: (id, i) => { state.checklists[id] = state.checklists[id] || {}; state.checklists[id][i] = !state.checklists[id][i]; saveState(); render(); },
            addRound: () => { state.activeWorkout.rounds++; saveState(); render(); },
            toggleTimer: () => {
                state.timerRunning = !state.timerRunning;
                if(state.timerRunning) { timerInterval = setInterval(() => { state.timer++; renderTimerUI(); }, 1000); }
                else { clearInterval(timerInterval); }
                render();
            },
            selectWorkout: (id) => {
                let w = null;
                for(const cat in WORKOUTS) { w = WORKOUTS[cat].find(x => x.id === id); if(w) break; }
                if(w) { state.activeWorkout = JSON.parse(JSON.stringify(w)); state.checklists = {}; state.warmupActive = false; saveState(); render(); }
            },
            randomizeTab: (tab) => { const list = WORKOUTS[tab]; if(list) APP.selectWorkout(list[Math.floor(Math.random()*list.length)].id); },
            randomizeGlobal: () => { 
                const pools = ['grind', 'ballistic', 'hybrid', 'conditioning'];
                const cat = pools[Math.floor(Math.random()*pools.length)];
                APP.randomizeTab(cat);
            },
            saveApiKey: () => { const input = document.getElementById('api-key-input'); if(input) { state.apiKey = input.value.trim(); localStorage.setItem(API_KEY_STORAGE, state.apiKey); render(); } },
            clearApiKey: () => { state.apiKey = ''; localStorage.removeItem(API_KEY_STORAGE); render(); },
            wipeData: () => { if(confirm('Wipe data?')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } },
            sendMessage: async () => {
                const input = document.getElementById('chat-input'); const text = input.value.trim(); if(!text) return;
                state.chatHistory.push({role: 'user', text: text}); render(); input.value = '';
                state.chatHistory.push({role: 'ai', text: 'Thinking...'}); render();
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: text }] }],
                            systemInstruction: { parts: [{ text: `Coach. Philosophy: ${KNOWLEDGE_BASE}. Direct, concise.` }] }
                        })
                    });
                    const data = await response.json();
                    state.chatHistory.pop();
                    state.chatHistory.push({role: 'ai', text: data.candidates[0].content.parts[0].text});
                    saveState(); render();
                } catch (e) { state.chatHistory.pop(); state.chatHistory.push({role: 'ai', text: "Error."}); render(); }
            }
        };

        function renderTimerUI() {
            const el = document.querySelector('.timer-val');
            if(el) {
                const mins = Math.floor(state.timer/60).toString().padStart(2,'0');
                const secs = (state.timer%60).toString().padStart(2,'0');
                el.innerText = `${mins}:${secs}`;
            }
        }

        function render() {
            const app = document.getElementById('app');
            let html = `<div class="pt-safe-top bg-zinc-900 border-b border-zinc-800 sticky top-0 z-50">
                <div class="h-14 flex items-center justify-between px-4">
                    <div class="flex items-center gap-1">
                        ${state.activeWorkout ? `<button onclick="APP.exitWorkout()" class="p-2 -ml-2 text-zinc-400">${Icons.ChevronLeft}</button>` : `<button onclick="APP.switchTab('home')" class="p-2 -ml-2 ${state.currentTab==='home'?'text-red-500':'text-zinc-400'}">${Icons.Home}</button>`}
                        <button onclick="APP.toggleWarmup()" class="p-2 ${state.warmupActive?'text-red-500':'text-zinc-400'}">${Icons.Flame}</button>
                    </div>
                    <h1 class="text-xs font-black tracking-widest text-white italic uppercase">The Iron Garage</h1>
                    <button onclick="APP.switchTab('history')" class="p-2 -mr-2 text-zinc-400">${Icons.History}</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto hide-scrollbar pb-safe-bottom bg-zinc-950 relative">`;

            if (state.warmupActive) {
                html += `<div class="p-6 space-y-6"><h2 class="text-2xl font-black italic uppercase">Daily Warm-up</h2><div class="space-y-4">${WARMUP_LIST.map(w=>`<div class="bg-zinc-900 p-4 rounded-2xl border border-zinc-800 shadow-lg"><h4 class="text-red-500 font-black text-xs uppercase mb-1">${w.title}</h4><p class="text-zinc-300 text-sm leading-snug">${w.desc}</p></div>`).join('')}</div><button onclick="APP.toggleWarmup()" class="w-full bg-zinc-100 text-zinc-950 py-4 font-black rounded-2xl uppercase tracking-widest mt-4">Ready to Lift</button></div>`;
            } else if (state.activeWorkout) {
                const w = state.activeWorkout;
                const completedRounds = state.checklists[w.id] ? Object.values(state.checklists[w.id]).filter(v => v).length : 0;
                const progress = Math.round((completedRounds / w.rounds) * 100);

                html += `<div class="p-6"><div class="flex justify-between items-start mb-2"><h2 class="text-2xl font-black italic uppercase leading-tight">${w.title}</h2>${state.timerRunning ? '<div class="w-3 h-3 bg-red-600 rounded-full active-pulse mt-2 ml-4"></div>':''}</div><p class="text-zinc-500 text-[10px] mb-6 uppercase tracking-widest font-bold">${w.difficulty} • ${w.equipment}</p>
                    
                    ${w.table ? `<div class="bg-zinc-900/50 rounded-2xl p-4 border border-zinc-800 mb-6 overflow-x-auto"><table class="w-full text-left text-[10px] text-zinc-300"><thead><tr class="border-b border-zinc-800"><th class="py-2 px-1">Load</th><th class="py-2 px-1 text-emerald-500">Beg.</th><th class="py-2 px-1 text-yellow-500">Mod.</th><th class="py-2 px-1 text-red-500">Adv.</th></tr></thead><tbody>${w.table.map(r=>`<tr class="border-b border-zinc-850 last:border-0"><td class="py-2 font-bold text-white px-1">${r.load}</td><td class="py-2 px-1">${r.beginner}</td><td class="py-2 px-1">${r.moderate}</td><td class="py-2 px-1">${r.advanced}</td></tr>`).join('')}</tbody></table></div>` : ''}

                    <div class="bg-zinc-900 border border-zinc-800 p-4 rounded-2xl mb-6 shadow-inner"><h4 class="text-[10px] font-bold text-zinc-500 uppercase mb-3 tracking-widest border-b border-zinc-800 pb-2">Protocol</h4><p class="text-xs text-zinc-400 italic mb-4 leading-relaxed">${w.protocol}</p><ul class="space-y-3">${w.movements.map(m=>`<li class="flex gap-3 text-sm text-zinc-200 font-medium"><span class="w-1.5 h-1.5 rounded-full bg-red-600 mt-2 shrink-0"></span>${m}</li>`).join('')}</ul></div>
                    <div class="flex justify-between items-end mb-4"><h4 class="text-sm font-bold text-white uppercase tracking-wider">Round Tracker</h4><span class="text-xs text-zinc-500 font-mono">${progress}%</span></div>
                    <div class="grid grid-cols-5 gap-2 mb-8">${Array.from({length:w.rounds}).map((_,i)=>`<label class="checkbox-wrapper relative"><input type="checkbox" class="opacity-0 absolute inset-0 z-10" ${state.checklists[w.id]?.[i]?'checked':''} onchange="APP.toggleRound('${w.id}',${i})"><div class="h-12 rounded-xl bg-zinc-900 border-2 border-zinc-800 flex items-center justify-center transition-all"><span class="text-xs font-bold text-zinc-600 ${state.checklists[w.id]?.[i]?'hidden':''}">${i+1}</span>${Icons.Check}</div></label>`).join('')}<button onclick="APP.addRound()" class="h-12 rounded-xl bg-zinc-950 border border-dashed border-zinc-800 text-zinc-700 flex items-center justify-center">+</button></div>
                    <button onclick="APP.completeWorkout()" class="w-full bg-zinc-100 text-zinc-950 py-4 font-black rounded-2xl uppercase tracking-widest shadow-xl active:scale-95 transition-transform">Finish Session</button></div>`;
            } else if (state.currentTab === 'history') {
                html += `<div class="p-6"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-black uppercase">Logs</h2><button onclick="APP.clearHistory()" class="text-xs text-red-500 uppercase font-bold">Clear</button></div>${state.history.length === 0 ? '<div class="text-center py-20 text-zinc-700 uppercase text-[10px] tracking-widest font-bold">No history found.</div>' : `<div class="space-y-3">${state.history.slice().reverse().map(h=>`<div class="bg-zinc-900 p-4 rounded-2xl flex justify-between items-center border border-zinc-900 shadow-md"><span class="font-bold text-xs text-zinc-200 uppercase tracking-tighter">${h.name}</span><span class="text-[9px] text-zinc-600 font-mono">${new Date(h.date).toLocaleDateString()}</span></div>`).join('')}</div>`}</div>`;
            } else if (state.currentTab === 'home') {
                const last = state.history[state.history.length-1];
                html += `<div class="p-6 space-y-6"><div class="bg-zinc-900 border border-zinc-800 p-8 rounded-3xl text-center space-y-6 shadow-2xl relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-red-600"></div>
                    <h2 class="text-3xl font-black italic uppercase leading-none">Garage<br>Roulette</h2>
                    <button onclick="APP.randomizeGlobal()" class="w-full bg-red-600 text-white font-black py-5 rounded-2xl shadow-lg uppercase tracking-widest active:scale-95 transition-transform">ROLL DICE</button>
                    ${last ? `<div class="text-[9px] text-zinc-500 uppercase font-bold tracking-tighter">Last Active: ${last.name}</div>` : ''}
                </div>
                <div class="bg-zinc-900 border border-zinc-800 p-4 rounded-3xl shadow-lg">
                    <div class="flex items-center gap-2 mb-4"><span class="text-red-500">${state.apiKey?Icons.Sparkles:Icons.Lock}</span><h3 class="font-black text-[10px] uppercase tracking-widest text-zinc-400">${state.apiKey?'AI Coach':'LOCKED'}</h3></div>
                    ${state.apiKey ? `<div id="chat-container" class="h-44 overflow-y-auto mb-3 flex flex-col gap-2 p-2 bg-zinc-950 rounded-2xl border border-zinc-900">${state.chatHistory.map(m=>`<div class="chat-bubble ${m.role==='user'?'chat-user ml-auto':'chat-ai mr-auto'}">${m.text}</div>`).join('')}</div><div class="flex gap-2"><input id="chat-input" type="text" class="flex-1 bg-zinc-800 border-none rounded-xl px-4 text-xs h-10" placeholder="Ask coach..."><button onclick="APP.sendMessage()" class="bg-zinc-100 text-zinc-900 px-3 rounded-xl">${Icons.Send}</button></div><button onclick="APP.clearApiKey()" class="text-[9px] text-zinc-600 mt-2 underline">Clear API Key</button>` : `<p class="text-[10px] text-zinc-600 mb-4 uppercase font-bold tracking-tight">Paste Gemini API Key to enable coach.</p><div class="flex gap-2"><input id="api-key-input" type="password" class="flex-1 bg-zinc-950 border border-zinc-800 rounded-xl px-4 text-xs h-10" placeholder="Key..."><button onclick="APP.saveApiKey()" class="bg-zinc-100 text-zinc-950 px-4 rounded-xl text-[10px] font-black uppercase">Save</button></div>`}
                </div></div>`;
            } else {
                html += `<div class="p-6"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-black uppercase italic tracking-widest leading-none">${state.currentTab}</h2><button onclick="APP.randomizeTab('${state.currentTab}')" class="text-red-600">${Icons.Shuffle}</button></div><div class="space-y-3">${WORKOUTS[state.currentTab].map(w=>`<div onclick="APP.selectWorkout('${w.id}')" class="bg-zinc-900 border border-zinc-800 p-4 rounded-2xl active:scale-[0.98] transition-all shadow-md"><div class="flex justify-between mb-1"><h3 class="font-black text-white uppercase italic text-xs tracking-wider">${w.title}</h3><div class="w-1.5 h-1.5 rounded-full ${w.difficulty==='beginner'?'bg-emerald-500':w.difficulty==='intermediate'?'bg-yellow-500':'bg-red-600'}"></div></div><p class="text-[10px] text-zinc-500 uppercase font-bold tracking-tighter">${w.equipment} • ${w.desc}</p></div>`).join('')}</div></div>`;
            }

            html += `</div>
            <div class="h-20 bg-zinc-900 border-t border-zinc-800 flex items-center justify-around px-2 relative z-50 overflow-x-auto hide-scrollbar">
                <button onclick="APP.switchTab('grind')" class="p-4 whitespace-nowrap text-[10px] font-black uppercase ${state.currentTab==='grind'?'text-red-500':'text-zinc-600'}">GRIND</button>
                <button onclick="APP.switchTab('ballistic')" class="p-4 whitespace-nowrap text-[10px] font-black uppercase ${state.currentTab==='ballistic'?'text-red-500':'text-zinc-600'}">BALLISTIC</button>
                <button onclick="APP.switchTab('conditioning')" class="p-4 whitespace-nowrap text-[10px] font-black uppercase ${state.currentTab==='conditioning'?'text-red-500':'text-zinc-600'}">COND.</button>
                <button onclick="APP.switchTab('hybrid')" class="p-4 whitespace-nowrap text-[10px] font-black uppercase ${state.currentTab==='hybrid'?'text-red-500':'text-zinc-600'}">HYBRID</button>
                <button onclick="APP.switchTab('tonic')" class="p-4 whitespace-nowrap text-[10px] font-black uppercase ${state.currentTab==='tonic'?'text-red-500':'text-zinc-600'}">TONIC</button>
                <button onclick="APP.switchTab('ruck')" class="p-4 whitespace-nowrap text-[10px] font-black uppercase ${state.currentTab==='ruck'?'text-red-500':'text-zinc-600'}">RUCK</button>
                <button onclick="APP.switchTab('rebuild')" class="p-4 whitespace-nowrap text-[10px] font-black uppercase ${state.currentTab==='rebuild'?'text-red-500':'text-zinc-600'}">REBUILD</button>
            </div>
            <button onclick="APP.toggleTimer()" class="floating-timer bg-zinc-900 border border-zinc-800 rounded-full h-14 pl-4 pr-6 flex items-center gap-3 shadow-2xl active:scale-90 transition-all border-l-4 border-l-red-600">
                <div class="text-red-500 ${state.timerRunning?'active-pulse':''}">${Icons.Timer}</div>
                <div class="timer-val font-mono text-lg font-black tracking-tighter">${Math.floor(state.timer/60).toString().padStart(2,'0')}:${(state.timer%60).toString().padStart(2,'0')}</div>
            </button>`;

            app.innerHTML = html;
            lucide.createIcons();
            const chatEl = document.getElementById('chat-container');
            if(chatEl) chatEl.scrollTop = chatEl.scrollHeight;
        }

        render();
    })();
    </script>
</body>
</html>
