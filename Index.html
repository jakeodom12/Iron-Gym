<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- SECURITY & PRIVACY -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://unpkg.com https://generativelanguage.googleapis.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:; connect-src 'self' https://generativelanguage.googleapis.com;">
    <meta name="referrer" content="no-referrer">
    <meta name="robots" content="noindex, nofollow, noarchive">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#09090b">
    <title>The Iron Garage</title>
    
    <!-- Tech Stack -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        zinc: { 850: '#1f1f22', 900: '#18181b', 950: '#09090b' },
                        iron: { red: '#dc2626', emerald: '#10b981', blue: '#3b82f6', amber: '#f59e0b', purple: '#8b5cf6' }
                    },
                    fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'] },
                    spacing: { 'safe-top': 'env(safe-area-inset-top)', 'safe-bottom': 'env(safe-area-inset-bottom)' }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; user-select: none; background-color: #09090b; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-active { border-bottom: 2px solid #dc2626; color: #f4f4f5; }
        .tab-active-rebuild { border-bottom: 2px solid #10b981; color: #f4f4f5; }
        .tab-active-tonic { border-bottom: 2px solid #3b82f6; color: #f4f4f5; }
        .tab-active-ruck { border-bottom: 2px solid #f59e0b; color: #f4f4f5; }
        .tab-active-history { border-bottom: 2px solid #8b5cf6; color: #f4f4f5; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #71717a; }
        .checkbox-wrapper input:checked + div { background-color: #dc2626; border-color: #dc2626; }
        .checkbox-wrapper input:checked + div svg { display: block; }
        /* Variations */
        .checkbox-wrapper-rebuild input:checked + div { background-color: #10b981; border-color: #10b981; }
        .checkbox-wrapper-rebuild input:checked + div svg { display: block; }
        .checkbox-wrapper-tonic input:checked + div { background-color: #3b82f6; border-color: #3b82f6; }
        .checkbox-wrapper-tonic input:checked + div svg { display: block; }
        .checkbox-wrapper-ruck input:checked + div { background-color: #f59e0b; border-color: #f59e0b; }
        .checkbox-wrapper-ruck input:checked + div svg { display: block; }
        /* Floating Timer */
        .floating-timer { position: fixed; bottom: calc(env(safe-area-inset-bottom) + 80px); right: 20px; z-index: 50; }
        /* Chat UI */
        .chat-bubble { max-width: 85%; padding: 12px; border-radius: 12px; margin-bottom: 8px; font-size: 0.9rem; line-height: 1.4; }
        .chat-user { background-color: #27272a; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-ai { background-color: #dc2626; color: white; align-self: flex-start; border-bottom-left-radius: 2px; }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-100 h-screen w-screen overflow-hidden flex flex-col font-sans">
    <div id="app" class="flex-1 flex flex-col h-full relative"></div>

    <script>
    (function() {
        const APP_BUILD_DATE = "Jan 14, 2026 - v17.0 (AI Trainer)";
        const STORAGE_KEY = 'iron-garage-v17'; 
        const apiKey = ""; // System will inject key at runtime

        const INVENTORY = {
            kbs: { pairs: [20, 24, 32], singles: [28, 44] },
            barbell: true,
            machines: ['Assault Runner', 'Reverse Hyper', 'Pull-up Bar', 'Sled']
        };

        const WARMUP_ROUTINE = [
            { title: "1. Meditation", desc: "1-Min: Sit quietly, close eyes, count breaths." },
            { title: "2. Mobility", desc: "30s Bar Hang + 30s Goblet Squat Hold." },
            { title: "3. Review", desc: "Check Journal & Compass." },
            { title: "4. Compass", desc: "Work, Rest, Play, Pray." },
            { title: "5. Warm-up Sets", desc: "1 set each: Press, Row, Hinge, Squat, Carry." }
        ];

        const WORKOUTS = {
            grind: [
                { id: 'es-classic', title: 'Easy Strength Classic', desc: '40-day protocol. Never fail.', equipment: 'Barbell', difficulty: 'beginner', protocol: '2x5. Leave fresh.', movements: ['Whole Body: DL/Swing', 'Push: Press/Bench', 'Pull: Pull-up/Row', 'Hinge/Squat', 'Carry'], rounds: 1 },
                { id: 'reg-park-5x5', title: 'Reg Park 5x5', desc: 'Grandfather of strength.', equipment: 'Barbell', difficulty: 'beginner', protocol: '2 warm-up, 3x5 work.', movements: ['Squat 5x5', 'Chin-ups 5x5', 'Dip/Bench 5x5', 'DL 5x5', 'Curl 3x10'], rounds: 1 },
                { id: 'mms-squat', title: 'Mass Made Simple (Lite)', desc: 'The "To 50" Squat Challenge.', equipment: 'Barbell', difficulty: 'advanced', protocol: 'Heavy upper body, high rep squats.', movements: ['Bench Press 3x5', 'Batwings 3x5', 'One-Arm Press 3x5', 'Bird Dog 2x10', 'Complex Warmup', 'High Rep Squats (Aim for 50 reps in fewest sets possible)'], rounds: 1 },
                { id: 'abf-press-day', title: 'ABF: Press Day', desc: 'Heavy volume pressing.', equipment: 'Double KBs', difficulty: 'intermediate', protocol: 'Ladders 2-3-5.', movements: ['Dbl Press: Ladders', 'Pull-ups: Match', 'Goblet Sq: Light'], rounds: 5 },
                { id: 'southwood', title: 'Southwood Program', desc: '4 day/week strength.', equipment: 'Barbell', difficulty: 'intermediate', protocol: '8-6-4 Reps.', movements: ['Clean', 'Press', 'F. Squat', 'Bench'], rounds: 1 },
                { id: 'rop-heavy', title: 'Rite of Passage', desc: 'Ladder press program.', equipment: 'Single KB', difficulty: 'advanced', protocol: 'Ladders 1-5.', movements: ['C&P Ladders', 'Pull-ups', 'Swings (Dice Roll)'], rounds: 5 },
                { id: 'complex-a', title: 'Barbell Complex A', desc: 'Wrestler Strength.', equipment: 'Barbell', difficulty: 'advanced', protocol: '8 reps. No drops.', movements: ['Row', 'Clean', 'F. Squat', 'Press', 'B. Squat', 'Good Morning'], rounds: 5 }
            ],
            ballistic: [
                { id: '10k-swing', title: '10,000 Swing Day', desc: 'The ultimate challenge.', equipment: 'Kettlebell', difficulty: 'advanced', protocol: '500 Swings total. Clusters of 10-15-25-50.', movements: ['Set 1: 10 Swings', 'Set 2: 15 Swings', 'Set 3: 25 Swings', 'Set 4: 50 Swings', 'Rest w/ 1 Strength Rep (Press/Dip)', 'Repeat 5 times (500 total)'], rounds: 5 },
                { id: 'litvinov', title: 'Litvinov Sprints', desc: 'Brutal athleticism.', equipment: 'Barbell + Track', difficulty: 'advanced', protocol: 'Lift then RUN.', movements: ['8 Front Squats (Heavy)', '400m Sprint (Immediate)', 'Rest 3-5 min'], rounds: 3 },
                { id: 'humane-burpee', title: 'Humane Burpee', desc: 'Volume descends.', equipment: 'Kettlebell', difficulty: 'intermediate', protocol: '15 Swings, Ladder 5->1.', movements: ['15 Swings', 'Goblet Sq (5->1)', 'Pushups (5->1)'], rounds: 5 },
                { id: 'eagle', title: 'The Eagle', desc: '8 Front Squats + Carry.', equipment: 'Double KBs', difficulty: 'advanced', protocol: 'No drops.', movements: ['8 Dbl F. Squats', '20m Rack Carry'], rounds: 8 },
                { id: 'snatch-test', title: 'The Snatch Test', desc: '100 Reps / 5 mins.', equipment: 'KB 24kg', difficulty: 'advanced', protocol: 'Time trial.', movements: ['20L/20R', '15L/15R', '10L/10R', '5L/5R'], rounds: 1 },
                { id: 'lift-n-sprint', title: 'Lift-n-Sprints', desc: 'Gear change drill.', equipment: 'KB/Runner', difficulty: 'intermediate', protocol: '10 reps -> Sprint.', movements: ['10 Swings', '100m Sprint'], rounds: 5 }
            ],
            hybrid: [
                { id: 'abc-double', title: 'Armor Building Complex', desc: '2 Cl, 1 Pr, 3 Sq.', equipment: 'Double KBs', difficulty: 'intermediate', protocol: 'EMOM or continuous.', movements: ['2 Cleans', '1 Press', '3 Front Squats'], rounds: 20 },
                { id: 'abc-single', title: 'Single KB ABC', desc: 'Asymmetry focus.', equipment: 'Single KB', difficulty: 'beginner', protocol: 'L -> R -> Sq.', movements: ['(L) 1 C&P', '(R) 1 C&P', '2 Goblet Sq'], rounds: 10 },
                { id: 'sparhawk', title: 'The Sparhawk', desc: 'Squat ladder w/ carries.', equipment: 'Single KB', difficulty: 'intermediate', protocol: 'Squat 8->1.', movements: ['Goblet Sq', 'Suitcase Carry L+R'], rounds: 8 },
                { id: 'carry-everything', title: 'Loaded Carry Day', desc: 'Festival of carries.', equipment: 'Various', difficulty: 'advanced', protocol: '1 set each.', movements: ['Suitcase', 'Farmer', 'Ruck', 'Sled', 'Bearhug'], rounds: 1 }
            ],
            tonic: [
                { id: 'plenty-of-nothing', title: 'I Got Plenty of Nothing!', desc: 'Foundational BW.', equipment: 'Floor', difficulty: 'beginner', protocol: 'Quality focus.', movements: ['Push-ups', 'Supermans', 'Hip Thrusts', 'Squats', 'Roll-ups', 'Walk'], rounds: 3 },
                { id: 'life-model', title: 'Life Model', desc: 'Crawl to rise.', equipment: 'Floor', difficulty: 'beginner', protocol: 'Restorative.', movements: ['Naked TGU', 'Kneeling Press', 'Bird Dog', 'OS Rocks'], rounds: 1 },
                { id: 'os-reset', title: 'OS Reset', desc: 'Nervous system.', equipment: 'Floor', difficulty: 'beginner', protocol: '20 min flow.', movements: ['Nods', 'Rocks', 'Crawl', 'Rolls'], rounds: 1 }
            ],
            ruck: [
                { id: 'ruck-15m', title: '1.5 Miles (Reset)', desc: 'Restorative.', equipment: 'Ruck', difficulty: 'beginner', protocol: 'Green light pace.', table: [{load:'10lb',time:'30:00'},{load:'45lb',time:'22:30'}], movements: ['1.5 Miles', 'Posture Focus'], rounds: 1 },
                { id: 'ruck-3k', title: '3.0 KM (Standard)', desc: 'Sweat & Recover.', equipment: 'Ruck', difficulty: 'intermediate', protocol: 'Zone 2.', table: [{load:'30lb',time:'32:00'}], movements: ['3.0 KM', 'Steady Pace'], rounds: 1 },
                { id: 'ruck-5k', title: '5.0 KM (Endurance)', desc: 'Training session.', equipment: 'Ruck', difficulty: 'advanced', protocol: 'Hydrate.', table: [{load:'30lb',time:'53:00'}], movements: ['5.0 KM', 'Grind'], rounds: 1 },
                { id: 'ruck-5m', title: '5.0 Miles (Long)', desc: 'Weekend Challenge.', equipment: 'Ruck', difficulty: 'advanced', protocol: '90+ mins.', table: [{load:'30lb',time:'1h 25m'}], movements: ['5.0 Miles', 'Durability'], rounds: 1 }
            ]
        };

        const REBUILD_PATHWAY = {
            overview: "12-week return-to-play. Reasonable, Repeatable, Doable.",
            weeks: [
                { week: 1, title: 'Week 1: Breath', context: 'Regulate system.', movements: ['Meditation', 'OS Nods', 'Walk'] },
                { week: 2, title: 'Week 2: Awakening', context: 'Range of motion.', movements: ['Hang 30s', 'Squat Hold 30s', 'Walk'] },
                { week: 3, title: 'Week 3: Patterning', context: 'Light load.', movements: ['Goblet Sq 1x5', 'Carry 20m', 'Walk'] },
                { week: 4, title: 'Week 4: Checkpoint', context: 'Integrity.', movements: ['Goblet Sq 2x5', 'Carry 40m', 'Walk'] },
                { week: 5, title: 'Week 5: Tension', context: '3x3 Rule.', movements: ['HK Press 3x3', 'Pull-up 3x3', 'Hip Thrust 3x10'] },
                { week: 6, title: 'Week 6: Stability', context: 'Fatigue mgmt.', movements: ['HK Press 3x3', 'Swing 3x10', 'Carry'] },
                { week: 7, title: 'Week 7: Volume', context: 'Shift to 2x5.', movements: ['HK Press 2x5', 'Pull-up 2x5', 'Swing 2x15'] },
                { week: 8, title: 'Week 8: Capacity', context: 'Test strength.', movements: ['HK Press 2x5+', 'Goblet 2x10', 'Carry'] },
                { week: 9, title: 'Week 9: Integration', context: 'Perfect Workout.', movements: ['[A] Press+Hang', '[B] Sq+Swing+Carry'] },
                { week: 10, title: 'Week 10: Density', context: 'Min Rest.', movements: ['[A] 3 Rnds', '[B] Higher Reps'] },
                { week: 11, title: 'Week 11: Load', context: 'Heavier.', movements: ['[A] Heavy Press', '[B] Heavy Swing'] },
                { week: 12, title: 'Week 12: Grad', context: 'Ready.', movements: ['[A] 3 Rnds', '[B] 2 Rnds'] }
            ]
        };

        // --- 2. STATE & API ---
        let state = { currentTab: 'home', activeWorkout: null, activeRebuildWeek: null, warmupActive: false, checklist: {}, timer: 0, timerRunning: false, history: [], chatHistory: [], ...loadState() };
        let timerInterval;

        function loadState() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch(e) { return {}; } }
        function saveState() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e) {} }

        // --- 3. ICONS ---
        const Icons = {
            Home: '<i data-lucide="home" class="w-5 h-5"></i>', Dumbbell: '<i data-lucide="dumbbell" class="w-5 h-5"></i>', Zap: '<i data-lucide="zap" class="w-5 h-5"></i>', Activity: '<i data-lucide="activity" class="w-5 h-5"></i>', Shuffle: '<i data-lucide="shuffle" class="w-6 h-6"></i>', ChevronLeft: '<i data-lucide="chevron-left" class="w-6 h-6"></i>', Check: '<i data-lucide="check" class="w-4 h-4 text-white hidden"></i>', Info: '<i data-lucide="info" class="w-5 h-5"></i>', Leaf: '<i data-lucide="leaf" class="w-5 h-5"></i>', Dices: '<i data-lucide="dices" class="w-8 h-8"></i>', Flame: '<i data-lucide="flame" class="w-5 h-5"></i>', X: '<i data-lucide="x" class="w-6 h-6"></i>', Calendar: '<i data-lucide="calendar" class="w-5 h-5"></i>', History: '<i data-lucide="clock" class="w-5 h-5"></i>', Footprints: '<i data-lucide="footprints" class="w-4 h-4"></i>', Trash: '<i data-lucide="trash-2" class="w-4 h-4"></i>', Save: '<i data-lucide="save" class="w-4 h-4"></i>', Timer: '<i data-lucide="timer" class="w-6 h-6"></i>', Sparkles: '<i data-lucide="sparkles" class="w-5 h-5"></i>', Send: '<i data-lucide="send" class="w-5 h-5"></i>'
        };

        function getDifficultyIcon(diff) { return diff === 'beginner' ? '<span class="inline-block w-2 h-2 rounded-full bg-emerald-500"></span>' : diff === 'intermediate' ? '<span class="inline-block w-2 h-2 rounded-full bg-yellow-500"></span>' : '<span class="inline-block w-2 h-2 rounded-full bg-red-600"></span>'; }
        function getIconForTab(tab) { if(tab==='grind') return Icons.Dumbbell; if(tab==='ballistic') return Icons.Zap; if(tab==='hybrid') return Icons.Activity; if(tab==='rebuild') return Icons.Leaf; if(tab==='tonic') return Icons.Tonic; if(tab==='ruck') return Icons.Footprints; if(tab==='history') return Icons.History; return Icons.Dumbbell; }

        // --- 4. RENDER ---
        function render() {
            const app = document.getElementById('app');
            let html = `
                <div class="pt-safe-top bg-zinc-900 border-b border-zinc-800 sticky top-0 z-50">
                    <div class="h-14 flex items-center justify-between px-4">
                        ${state.activeWorkout ? `<button onclick="APP.exitWorkout()" class="p-2 -ml-2 text-zinc-400 hover:text-white">${Icons.ChevronLeft}</button>` : `<button onclick="APP.toggleWarmup()" class="p-2 -ml-2 text-zinc-400 hover:text-red-500">${Icons.Flame}</button>`}
                        <h1 class="text-lg font-bold tracking-tight text-white uppercase italic">The Iron Garage</h1>
                        <button onclick="APP.showInventory()" class="p-2 -mr-2 text-zinc-400 hover:text-white">${Icons.Info}</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto overflow-x-hidden hide-scrollbar pb-safe-bottom bg-zinc-950 relative">`;
            
            if (state.warmupActive) html += renderWarmup();
            else if (state.activeWorkout) html += renderActiveWorkout();
            else html += renderDashboard();
            
            if(state.activeWorkout) html += renderFloatingTimer();
            
            html += `</div>`;
            app.innerHTML = html;
            lucide.createIcons();
            
            // Scroll chat to bottom if open
            const chatContainer = document.getElementById('chat-container');
            if(chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function renderFloatingTimer() {
            const mins = Math.floor(state.timer / 60).toString().padStart(2, '0');
            const secs = (state.timer % 60).toString().padStart(2, '0');
            return `
                <button onclick="APP.toggleTimer()" class="floating-timer bg-zinc-800 border border-zinc-700 text-white rounded-full h-14 pl-4 pr-5 flex items-center gap-2 shadow-xl shadow-black/50 active:scale-95 transition-transform">
                    <span class="${state.timerRunning ? 'text-red-500 animate-pulse' : 'text-zinc-400'}">${Icons.Timer}</span>
                    <span class="font-mono text-lg font-bold">${mins}:${secs}</span>
                </button>`;
        }

        function renderWarmup() {
            return `<div class="p-6 space-y-6"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-black text-white uppercase">Daily Warm-up</h2><button onclick="APP.toggleWarmup()" class="text-zinc-400 hover:text-white">${Icons.X}</button></div><div class="space-y-4">${WARMUP_ROUTINE.map(s=>`<div class="bg-zinc-900 border border-zinc-800 p-4 rounded-xl"><h3 class="text-red-500 font-bold uppercase text-sm mb-1">${s.title}</h3><p class="text-zinc-300 text-sm leading-snug">${s.desc}</p></div>`).join('')}</div><button onclick="APP.toggleWarmup()" class="w-full bg-zinc-100 text-zinc-900 font-bold py-4 rounded-xl mt-8">Ready to Lift</button></div>`;
        }

        function renderDashboard() {
            const tabs = ['home','grind','ballistic','hybrid','tonic','ruck','rebuild','history'];
            let nav = `<div class="flex border-b border-zinc-800 bg-zinc-900 sticky top-0 z-40 overflow-x-auto hide-scrollbar">`;
            tabs.forEach(t => {
                let cls = state.currentTab===t ? (t==='rebuild'?'tab-active-rebuild':t==='tonic'?'tab-active-tonic':t==='ruck'?'tab-active-ruck':t==='history'?'tab-active-history':'tab-active') : 'tab-inactive';
                nav += `<button onclick="APP.switchTab('${t}')" class="flex-1 py-4 ${t==='home'?'flex justify-center min-w-[60px]':'text-xs font-bold uppercase tracking-wider text-center min-w-[80px]'} ${cls}">${t==='home'?Icons.Home:t}</button>`;
            });
            nav += `</div>`;

            if(state.currentTab==='home') return nav + renderHome();
            if(state.currentTab==='rebuild') return nav + renderRebuildHub();
            if(state.currentTab==='history') return nav + renderHistory();

            let content = '';
            if(state.currentTab==='ruck') content += `<div class="p-4"><div class="bg-zinc-900 border border-amber-900/30 p-4 rounded-2xl mb-4 text-sm text-zinc-400"><strong class="text-amber-500 block mb-1">Ruck Rules</strong>Don't Run. Posture First. Talk Test.</div>`;
            else if(state.currentTab!=='tonic') content += `<div class="px-4 pt-6 pb-2"><button onclick="APP.randomizeInTab('${state.currentTab}')" class="w-full bg-gradient-to-r from-red-600 to-red-700 text-white rounded-xl py-4 shadow-lg flex items-center justify-center gap-2">${Icons.Shuffle}<span class="font-bold uppercase">Roll Dice: ${state.currentTab}</span></button></div>`;
            
            content += `<div class="p-4 space-y-3">`;
            WORKOUTS[state.currentTab].forEach(w => {
                content += `<div onclick="APP.selectWorkout('${w.id}')" class="bg-zinc-900 border border-zinc-800 rounded-xl p-4 cursor-pointer relative group"><div class="absolute top-0 right-0 p-2">${getDifficultyIcon(w.difficulty)}</div><h3 class="text-white font-bold text-lg">${w.title}</h3><p class="text-zinc-400 text-sm mb-2">${w.desc}</p><div class="flex items-center gap-2 text-xs text-zinc-500">${getIconForTab(state.currentTab)}<span>${w.equipment}</span></div></div>`;
            });
            content += `</div>`;
            if(state.currentTab==='ruck') content += `</div>`;
            return nav + content;
        }

        function renderRebuildHub() {
            if(state.activeRebuildWeek!==null) {
                const w = REBUILD_PATHWAY.weeks.find(x=>x.week===state.activeRebuildWeek);
                return `<div class="p-6"><button onclick="APP.clearRebuildWeek()" class="flex items-center text-emerald-500 text-sm font-bold mb-4">${Icons.ChevronLeft} Roadmap</button><div class="bg-zinc-900 border border-emerald-900/30 p-6 rounded-2xl mb-6"><h2 class="text-xl font-bold text-white">${w.title}</h2><p class="text-zinc-300 text-sm mt-2">${w.context}</p></div><div class="bg-zinc-900 border border-zinc-800 rounded-xl p-4"><ul class="space-y-3">${w.movements.map(m=>`<li class="flex gap-3 text-zinc-200 text-sm"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-2 shrink-0"></span>${m}</li>`).join('')}</ul><button onclick="APP.startRebuildSession(${w.week})" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg mt-6 uppercase text-sm">Start</button></div></div>`;
            }
            return `<div class="p-6 space-y-6"><div class="bg-zinc-900 p-5 rounded-2xl border border-zinc-800"><h2 class="text-xl font-bold text-white mb-2 flex gap-2"><span class="text-emerald-500">${Icons.Leaf}</span>Mission Brief</h2><p class="text-zinc-400 text-sm">${REBUILD_PATHWAY.overview}</p></div><div class="grid grid-cols-4 gap-2">${REBUILD_PATHWAY.weeks.map(w=>`<button onclick="APP.setRebuildWeek(${w.week})" class="aspect-square bg-zinc-900 border border-zinc-800 rounded-xl flex flex-col items-center justify-center hover:border-emerald-500"><span class="text-[10px] text-zinc-500">WK</span><span class="text-xl font-bold text-white">${w.week}</span></button>`).join('')}</div></div>`;
        }

        function renderHome() {
            const last = state.history.length > 0 ? state.history[state.history.length-1] : null;
            return `
            <div class="p-6 flex flex-col gap-6 min-h-[80vh]">
                <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-8 flex flex-col items-center text-center space-y-5 shadow-xl mt-4">
                    <div class="bg-red-900/10 p-5 rounded-full border border-red-900/30 text-red-500">${Icons.Dices}</div>
                    <h2 class="text-2xl font-black text-white uppercase italic">Garage Roulette</h2>
                    <button onclick="APP.randomizeGlobal()" class="w-full bg-red-600 text-white font-bold py-4 rounded-xl uppercase shadow-lg gap-2 flex items-center justify-center">${Icons.Shuffle} Randomize All</button>
                    <div class="flex gap-4 mt-2">
                        <button onclick="APP.wipeData()" class="text-[10px] text-zinc-600 hover:text-red-500 flex gap-1">${Icons.Trash} Burn</button>
                        <button onclick="APP.exportData()" class="text-[10px] text-zinc-600 hover:text-white flex gap-1">${Icons.Save} Backup</button>
                    </div>
                    ${last?`<div class="text-xs text-zinc-500 mt-4 border-t border-zinc-800 pt-2 w-full">Last: ${last.name} (${new Date(last.date).toLocaleDateString()})</div>`:''}
                </div>
                
                <!-- ASK THE TRAINER AI MODULE -->
                <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-4 flex flex-col shadow-lg">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="text-red-500 bg-red-900/20 p-2 rounded-lg">${Icons.Sparkles}</div>
                        <h3 class="text-white font-bold text-sm uppercase tracking-wide">Ask The Trainer</h3>
                    </div>
                    <div id="chat-container" class="bg-zinc-950 rounded-xl p-3 h-48 overflow-y-auto mb-3 flex flex-col gap-2 border border-zinc-800/50">
                        ${state.chatHistory.length === 0 ? '<div class="text-zinc-500 text-xs italic text-center mt-10">Ask about injuries, substitutions, or protocol details...</div>' : state.chatHistory.map(msg => `<div class="chat-bubble ${msg.role === 'user' ? 'chat-user' : 'chat-ai'}">${msg.text}</div>`).join('')}
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="chat-input" class="flex-1 bg-zinc-800 border border-zinc-700 rounded-lg px-3 text-sm text-white focus:outline-none focus:border-red-500 transition-colors" placeholder="e.g. 'Back hurts, sub for DL?'">
                        <button onclick="APP.sendMessage()" class="bg-red-600 text-white p-2 rounded-lg hover:bg-red-500 transition-colors">${Icons.Send}</button>
                    </div>
                </div>

                <div class="text-[10px] text-zinc-700 font-mono text-center">Build: ${APP_BUILD_DATE}<br>Philosophy: Dan John</div>
            </div>`;
        }

        function renderHistory() {
            if(!state.history.length) return `<div class="p-10 text-center text-zinc-500">No workouts completed yet.</div>`;
            return `<div class="p-4 space-y-2">${state.history.slice().reverse().map(h=>`<div class="bg-zinc-900 border border-zinc-800 p-3 rounded-lg flex justify-between items-center"><span class="text-white font-bold text-sm">${h.name}</span><span class="text-xs text-zinc-500">${new Date(h.date).toLocaleDateString()}</span></div>`).join('')}</div>`;
        }

        function renderActiveWorkout() {
            const w = state.activeWorkout;
            let theme = 'bg-red-900/30 text-red-500 border-red-900/50';
            let check = 'checkbox-wrapper';
            if (w.id.includes('rebuild')) { theme = 'bg-emerald-900/30 text-emerald-500 border-emerald-900/50'; check = 'checkbox-wrapper-rebuild'; }
            else if (state.currentTab === 'tonic') { theme = 'bg-blue-900/30 text-blue-500 border-blue-900/50'; check = 'checkbox-wrapper-tonic'; }
            else if (state.currentTab === 'ruck') { theme = 'bg-amber-900/30 text-amber-500 border-amber-900/50'; check = 'checkbox-wrapper-ruck'; }

            return `<div class="min-h-full pb-24"><div class="px-6 pt-8 pb-6 bg-zinc-900 border-b border-zinc-800"><div class="inline-block px-2 py-1 rounded ${theme} text-xs font-bold uppercase tracking-wider border mb-3">Active Session</div><h2 class="text-3xl font-black text-white mb-2 leading-none">${w.title}</h2><p class="text-zinc-400 text-sm">${w.desc}</p></div><div class="p-6 space-y-6"><div class="bg-zinc-900/50 rounded-lg p-4 border border-zinc-800"><h4 class="text-xs font-bold text-zinc-500 uppercase tracking-wider mb-2">Protocol</h4><ul class="space-y-2">${w.movements.map(m=>`<li class="flex gap-3 text-zinc-300 text-sm"><span class="w-1.5 h-1.5 rounded-full bg-zinc-600 mt-2 shrink-0"></span>${m}</li>`).join('')}</ul></div><div><div class="grid grid-cols-5 gap-2">${Array.from({length:w.rounds}).map((_,i)=>`<label class="${check} cursor-pointer relative"><input type="checkbox" class="opacity-0 absolute w-full h-full z-10" ${state.checklist[i]?'checked':''} onchange="APP.toggleRound(${i})"><div class="h-12 rounded bg-zinc-800 border-2 border-zinc-700 flex items-center justify-center transition-all"><span class="text-sm font-bold text-zinc-500 ${state.checklist[i]?'hidden':'block'}">${i+1}</span>${Icons.Check}</div></label>`).join('')}<button onclick="APP.addRound()" class="h-12 rounded bg-zinc-900 border border-dashed border-zinc-700 flex items-center justify-center text-zinc-500"><span class="text-xl font-bold">+</span></button></div></div><div class="pt-8"><button onclick="APP.completeWorkout()" class="w-full py-4 bg-zinc-100 text-zinc-900 font-bold uppercase rounded-xl">Finish Session</button></div></div></div>`;
        }

        // --- 5. LOGIC & API ---
        window.APP = {
            switchTab: (t) => { state.currentTab = t; saveState(); render(); },
            toggleWarmup: () => { state.warmupActive = !state.warmupActive; render(); },
            exitWorkout: () => { clearInterval(timerInterval); state.activeWorkout = null; state.checklist = {}; state.timer = 0; state.timerRunning = false; saveState(); render(); },
            completeWorkout: () => { 
                if(confirm('Finish workout?')) { 
                    state.history.push({ name: state.activeWorkout.title, date: new Date().toISOString() });
                    APP.exitWorkout(); 
                } 
            },
            toggleRound: (i) => { state.checklist[i] = !state.checklist[i]; saveState(); render(); },
            addRound: () => { if(state.activeWorkout) { state.activeWorkout.rounds++; saveState(); render(); } },
            toggleTimer: () => {
                state.timerRunning = !state.timerRunning;
                if(state.timerRunning) { timerInterval = setInterval(() => { state.timer++; renderFloatingTimerUI(); }, 1000); }
                else { clearInterval(timerInterval); renderFloatingTimerUI(); }
                render(); 
            },
            setRebuildWeek: (wk) => { state.activeRebuildWeek = wk; saveState(); render(); },
            clearRebuildWeek: () => { state.activeRebuildWeek = null; saveState(); render(); },
            startRebuildSession: (wk) => {
                const w = REBUILD_PATHWAY.weeks.find(x=>x.week===wk);
                state.activeWorkout = { id: `rebuild-${wk}`, title: w.title, desc: w.context, equipment: 'Bodyweight/Light', difficulty: 'beginner', movements: w.movements, rounds: 1 };
                state.checklist = {}; saveState(); render();
            },
            selectWorkout: (id) => {
                let w = null;
                for(const k in WORKOUTS) { w = WORKOUTS[k].find(x=>x.id===id); if(w) break; }
                if(w) { state.activeWorkout = w; state.checklist = {}; state.warmupActive = false; saveState(); render(); }
            },
            randomizeInTab: (tab) => { const list = WORKOUTS[tab]; if(list) APP.selectWorkout(list[Math.floor(Math.random()*list.length)].id); },
            randomizeGlobal: () => { const all = [WORKOUTS.grind, WORKOUTS.ballistic, WORKOUTS.hybrid].flat(); APP.selectWorkout(all[Math.floor(Math.random()*all.length)].id); },
            showInventory: () => alert(`KBs: ${INVENTORY.kbs.pairs.join(', ')} (Pairs)\nBarbell, ${INVENTORY.machines.join(', ')}`),
            wipeData: () => { if(confirm('Permanently delete all data?')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } },
            exportData: () => { navigator.clipboard.writeText(JSON.stringify(state)).then(()=>alert('Data copied to clipboard')); },
            
            // --- AI Logic ---
            sendMessage: async () => {
                const input = document.getElementById('chat-input');
                const text = input.value.trim();
                if(!text) return;
                
                // Add user message
                state.chatHistory.push({role: 'user', text: text});
                render(); // Re-render to show user msg
                input.value = '';

                // Prepare Loading
                const loadingMsg = {role: 'ai', text: 'Thinking...'};
                state.chatHistory.push(loadingMsg);
                render();

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: `You are an expert strength coach following the philosophy of Dan John (Easy Strength, Armor Building). 
                                           User Inventory: ${JSON.stringify(INVENTORY)}. 
                                           User Query: ${text}. 
                                           Keep answer short (under 50 words), actionable, and "tough love" style.`
                                }]
                            }]
                        })
                    });
                    
                    const data = await response.json();
                    const reply = data.candidates[0].content.parts[0].text;
                    
                    // Replace loading with actual reply
                    state.chatHistory.pop(); 
                    state.chatHistory.push({role: 'ai', text: reply});
                    saveState();
                    render();
                } catch (e) {
                    state.chatHistory.pop();
                    state.chatHistory.push({role: 'ai', text: "Offline mode. Check connection."});
                    render();
                }
            }
        };

        // Internal helper to avoid full re-render on timer tick
        function renderFloatingTimerUI() {
            const btn = document.querySelector('.floating-timer');
            if(btn) {
                const mins = Math.floor(state.timer/60).toString().padStart(2,'0');
                const secs = (state.timer%60).toString().padStart(2,'0');
                btn.innerHTML = `<span class="${state.timerRunning?'text-red-500 animate-pulse':'text-zinc-400'}">${Icons.Timer}</span><span class="font-mono text-lg font-bold">${mins}:${secs}</span>`;
            }
        }

        // Public API for Power Users
        window.IronGarageAPI = {
            getHistory: () => state.history,
            exportState: () => JSON.stringify(state),
            importState: (json) => { try { state = JSON.parse(json); saveState(); render(); console.log('State imported'); } catch(e){ console.error('Invalid JSON'); } },
            getWorkouts: () => WORKOUTS
        };

        render();
    })();
    </script>
</body>
</html>
