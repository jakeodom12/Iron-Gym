<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- SECURITY & PRIVACY -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://unpkg.com https://generativelanguage.googleapis.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:; connect-src 'self' https://generativelanguage.googleapis.com;">
    <meta name="referrer" content="no-referrer">
    <meta name="robots" content="noindex, nofollow, noarchive">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#09090b">
    <title>The Iron Garage</title>
    
    <!-- Tech Stack -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        zinc: { 850: '#1f1f22', 900: '#18181b', 950: '#09090b' },
                        iron: { red: '#dc2626', emerald: '#10b981', blue: '#3b82f6', amber: '#f59e0b', purple: '#8b5cf6', cyan: '#06b6d4', rose: '#e11d48' }
                    },
                    fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'] },
                    spacing: { 'safe-top': 'env(safe-area-inset-top)', 'safe-bottom': 'env(safe-area-inset-bottom)' }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; user-select: none; background-color: #09090b; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-active { border-bottom: 2px solid #dc2626; color: #f4f4f5; }
        .tab-active-rebuild { border-bottom: 2px solid #10b981; color: #f4f4f5; }
        .tab-active-tonic { border-bottom: 2px solid #3b82f6; color: #f4f4f5; }
        .tab-active-ruck { border-bottom: 2px solid #f59e0b; color: #f4f4f5; }
        .tab-active-emom { border-bottom: 2px solid #06b6d4; color: #f4f4f5; }
        .tab-active-cond { border-bottom: 2px solid #e11d48; color: #f4f4f5; }
        .tab-active-history { border-bottom: 2px solid #8b5cf6; color: #f4f4f5; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #71717a; }
        
        .checkbox-wrapper input:checked + div { background-color: #dc2626; border-color: #dc2626; }
        .checkbox-wrapper input:checked + div svg { display: block; }
        
        /* Variations */
        .checkbox-wrapper-rebuild input:checked + div { background-color: #10b981; border-color: #10b981; }
        .checkbox-wrapper-rebuild input:checked + div svg { display: block; }
        .checkbox-wrapper-tonic input:checked + div { background-color: #3b82f6; border-color: #3b82f6; }
        .checkbox-wrapper-tonic input:checked + div svg { display: block; }
        .checkbox-wrapper-ruck input:checked + div { background-color: #f59e0b; border-color: #f59e0b; }
        .checkbox-wrapper-ruck input:checked + div svg { display: block; }
        .checkbox-wrapper-emom input:checked + div { background-color: #06b6d4; border-color: #06b6d4; }
        .checkbox-wrapper-emom input:checked + div svg { display: block; }
        .checkbox-wrapper-cond input:checked + div { background-color: #e11d48; border-color: #e11d48; }
        .checkbox-wrapper-cond input:checked + div svg { display: block; }
        
        /* Floating Timer */
        .floating-timer { position: fixed; bottom: calc(env(safe-area-inset-bottom) + 80px); right: 20px; z-index: 50; }
        /* Chat UI */
        .chat-bubble { max-width: 85%; padding: 12px; border-radius: 12px; margin-bottom: 8px; font-size: 0.9rem; line-height: 1.4; }
        .chat-user { background-color: #27272a; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-ai { background-color: #dc2626; color: white; align-self: flex-start; border-bottom-left-radius: 2px; }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-100 h-screen w-screen overflow-hidden flex flex-col font-sans">
    <div id="app" class="flex-1 flex flex-col h-full relative"></div>

    <script>
    (function() {
        const APP_BUILD_DATE = "Jan 14, 2026 - v21.0 (Conditioning +)";
        const STORAGE_KEY = 'iron-garage-v21'; 
        const API_KEY_STORAGE = 'iron-garage-api-key';

        // Expanded Knowledge Base
        const KNOWLEDGE_BASE = `
            PHILOSOPHY: The Architecture of Adaptation. SAID Principle.
            GOALS: Hypertrophy (Structure), Strength (Neural), Endurance (Metabolic).
            VARIABLES: Load, Volume, Frequency, Rest. 
            BIOMECHANICS: Barbells (Max Load), Dumbbells (Stabilizers).
            CONDITIONING: 
            - True Speed: Max effort <10s, Full Rest (3-5m). Neurological focus.
            - Speed Endurance: High intensity, incomplete recovery. "The Burn".
            - Aerobic: Sustained effort.
            - Assault Runner: Taxing. Lower volume than outdoor running.
            FATIGUE: Acute variables dictate outcome. Deloads are structural necessities.
            RULES: Warm-up is non-negotiable. If you draw two Max Power days, re-roll.
        `;

        const INVENTORY = {
            kbs: { pairs: [20, 24, 32], singles: [28, 44] },
            barbell: true,
            machines: ['Assault Runner', 'Reverse Hyper', 'Pull-up Bar', 'Sled']
        };

        const WARMUP_ROUTINE = [
            { title: "1. Meditation", desc: "1-Min: Sit quietly, close eyes, count breaths." },
            { title: "2. Mobility", desc: "30s Bar Hang + 30s Goblet Squat Hold." },
            { title: "3. Review", desc: "Check Journal & Compass." },
            { title: "4. Compass", desc: "Work, Rest, Play, Pray." },
            { title: "5. Warm-up Sets", desc: "1 set each: Press, Row, Hinge, Squat, Carry." }
        ];

        const WORKOUTS = {
            grind: [
                { id: 'es-classic', title: 'Easy Strength Classic', desc: '40-day protocol.', equipment: 'Barbell', difficulty: 'beginner', protocol: '2x5. Leave fresh.', movements: ['Whole Body: DL/Swing (2x5)', 'Push: Press/Bench (2x5)', 'Pull: Pull-up/Row (2x5)', 'Hinge/Squat: Front/Goblet Sq (2x5)', 'Loaded Carry: Farmer Walk'], rounds: 1 },
                { id: 'architect-ppl', title: 'The Architect PPL', desc: 'Hypertrophy focus.', equipment: 'Barbell/DB', difficulty: 'intermediate', protocol: 'Push/Pull/Legs.', movements: ['Push: Bench 3x8, Incline 3x10, Lat Raise 3x12', 'Pull: Row 3x8, Pull-ups 3xAMRAP, Curl 3x10', 'Legs: Squat 3x6, RDL 3x10, Lunges 3x12'], rounds: 1 },
                { id: 'db-symmetry', title: 'DB Symmetry Split', desc: 'Upper/Lower DB.', equipment: 'Dumbbells', difficulty: 'intermediate', protocol: 'Unilateral focus.', movements: ['Upper: DB Bench 3x10, DB Row 3x10, Press 3x12', 'Lower: Goblet 3x12, DB RDL 3x12, Step-ups 3x10'], rounds: 1 },
                { id: 'said-strength', title: 'SAID Protocol', desc: 'Neural Drive.', equipment: 'Barbell', difficulty: 'advanced', protocol: 'High intensity.', movements: ['Squat: 5x3 @ 85%', 'Bench: 5x3 @ 85%', 'Deadlift: 3x2 @ 90%'], rounds: 1 },
                { id: 'reg-park-5x5', title: 'Reg Park 5x5', desc: 'Classic Strength.', equipment: 'Barbell', difficulty: 'beginner', protocol: '2 warm-ups, 3x5 work.', movements: ['Squat 5x5', 'Chin-ups 5x5', 'Dip/Bench 5x5', 'Deadlift 5x5', 'Curl 3x10'], rounds: 1 },
                { id: 'mms-squat', title: 'Mass Made Simple (Lite)', desc: 'To 50 Squat.', equipment: 'Barbell', difficulty: 'advanced', protocol: 'Heavy upper, high rep squat.', movements: ['Bench 3x5', 'Batwings 3x5', '1-Arm Press 3x5', 'Bird Dog 2x10', 'Squats: To 50 reps'], rounds: 1 },
                { id: 'abf-press-day', title: 'ABF: Press Day', desc: 'Volume pressing.', equipment: 'Double KBs', difficulty: 'intermediate', protocol: 'Ladders 2-3-5.', movements: ['Dbl Press: Ladders 2-3-5', 'Pull-ups: Match sets', 'Goblet Sq: Light'], rounds: 5 },
                { id: 'rop-heavy', title: 'Rite of Passage', desc: 'Ladder press.', equipment: 'Single KB', difficulty: 'advanced', protocol: 'Ladders 1-5.', movements: ['C&P Ladders', 'Pull-ups', 'Swings (Dice Roll)'], rounds: 5 },
                { id: 'complex-a', title: 'Barbell Complex A', desc: 'Wrestler Strength.', equipment: 'Barbell', difficulty: 'advanced', protocol: '8 reps. No drops.', movements: ['Row', 'Clean', 'F. Squat', 'Press', 'B. Squat', 'Good Morning'], rounds: 5 }
            ],
            ballistic: [
                { id: '10k-swing', title: '10,000 Swing Day', desc: 'The ultimate challenge.', equipment: 'Kettlebell', difficulty: 'advanced', protocol: '500 Swings total.', movements: ['Set 1: 10 Swings', 'Set 2: 15 Swings', 'Set 3: 25 Swings', 'Set 4: 50 Swings', 'Rest w/ 1 Strength Rep', 'Repeat 5 times'], rounds: 5 },
                { id: 'humane-burpee', title: 'Humane Burpee', desc: 'Volume descends.', equipment: 'Kettlebell', difficulty: 'intermediate', protocol: '15 Swings, Ladder 5->1.', movements: ['15 Swings', 'Goblet Sq (5->1)', 'Pushups (5->1)'], rounds: 5 },
                { id: 'eagle', title: 'The Eagle', desc: '8 Front Squats + Carry.', equipment: 'Double KBs', difficulty: 'advanced', protocol: 'No drops.', movements: ['8 Dbl F. Squats', '20m Rack Carry'], rounds: 8 },
                { id: 'snatch-test', title: 'The Snatch Test', desc: '100 Reps / 5 mins.', equipment: 'KB 24kg', difficulty: 'advanced', protocol: 'Time trial.', movements: ['20L/20R', '15L/15R', '10L/10R', '5L/5R'], rounds: 1 },
                { id: 'lift-n-sprint', title: 'Lift-n-Sprints', desc: 'Gear change drill.', equipment: 'KB/Runner', difficulty: 'intermediate', protocol: '10 reps -> Sprint.', movements: ['10 Swings', '100m Sprint'], rounds: 5 }
            ],
            hybrid: [
                { id: 'abc-double', title: 'Armor Building Complex', desc: '2 Cl, 1 Pr, 3 Sq.', equipment: 'Double KBs', difficulty: 'intermediate', protocol: 'EMOM or continuous.', movements: ['2 Cleans', '1 Press', '3 Front Squats'], rounds: 20 },
                { id: 'abc-single', title: 'Single KB ABC', desc: 'Asymmetry focus.', equipment: 'Single KB', difficulty: 'beginner', protocol: 'L -> R -> Sq.', movements: ['(L) 1 C&P', '(R) 1 C&P', '2 Goblet Sq'], rounds: 10 },
                { id: 'sparhawk', title: 'The Sparhawk', desc: 'Squat ladder w/ carries.', equipment: 'Single KB', difficulty: 'intermediate', protocol: 'Squat 8->1.', movements: ['Goblet Sq', 'Suitcase Carry L+R'], rounds: 8 },
                { id: 'carry-everything', title: 'Loaded Carry Day', desc: 'Festival of carries.', equipment: 'Various', difficulty: 'advanced', protocol: '1 set each.', movements: ['Suitcase', 'Farmer', 'Ruck', 'Sled', 'Bearhug'], rounds: 1 }
            ],
            emom: [
                { id: 'db-classic', title: 'The Dumbbell Classic', desc: '20 Min Rotating.', equipment: 'Pair DBs', difficulty: 'intermediate', protocol: 'Start every min.', movements: ['Min 1: 12 Thrusters', 'Min 2: 12 Rows', 'Min 3: 15 Goblet Sq', 'Min 4: 12 Burpees', 'Repeat 5x'], rounds: 5 },
                { id: 'bb-foundation', title: 'Barbell Foundation', desc: '24 Min Strength.', equipment: 'Barbell', difficulty: 'intermediate', protocol: 'Start every min.', movements: ['Min 1: 8 DL', 'Min 2: 8 Press', 'Min 3: 8 F. Sq', 'Min 4: Rest', 'Repeat 6x'], rounds: 6 },
                { id: 'kb-flow', title: 'Kettlebell Flow', desc: '20 Min Flow.', equipment: 'Single KB', difficulty: 'intermediate', protocol: 'Start every min.', movements: ['Min 1: 15 Swings', 'Min 2: 8 C&P (R)', 'Min 3: 8 C&P (L)', 'Min 4: 20 Lunges', 'Repeat 5x'], rounds: 5 },
                { id: 'emom-mixer', title: 'The EMOM Mixer', desc: '12 Min Density.', equipment: 'Runner, DB', difficulty: 'advanced', protocol: '12 Min EMOM.', movements: ['Min 1: 150m Sprint', 'Min 2: 12 DB Thrusters', 'Min 3: 12 Burpees', 'Repeat 4x'], rounds: 4 }
            ],
            conditioning: [ // NEW TAB
                // True Speed
                { id: 'peak-wattage', title: 'Peak Wattage Hunters', desc: 'Max Power.', equipment: 'Assault Runner', difficulty: 'advanced', protocol: 'Max effort, full rest.', movements: ['10s ALL OUT Sprint', '3 min Rest (Walk)', 'Repeat 6x'], rounds: 6 },
                { id: 'sled-push-sim', title: 'Sled Push Simulator', desc: 'Grindy Speed.', equipment: 'Assault Runner', difficulty: 'intermediate', protocol: 'Resistance Run.', movements: ['15s Resisted Drive', '90s Rest (Walk)', 'Repeat 10x'], rounds: 10 },
                { id: '15s-flys', title: '15-Second Flys', desc: 'Top-end Velocity.', equipment: 'Assault Runner', difficulty: 'advanced', protocol: '95-100% Effort.', movements: ['15s Sprint', '2:30 Rest (Jog/Walk)', 'Repeat 8x'], rounds: 8 },
                { id: 'build-blast', title: 'Build and Blast', desc: 'Controlled Accel.', equipment: 'Assault Runner', difficulty: 'intermediate', protocol: '20s Total Work.', movements: ['10s Build Speed', '10s Max Effort', '3 min Rest', 'Repeat 5x'], rounds: 5 },
                { id: 'flying-sprints', title: 'Flying Sprints', desc: 'Max Velocity.', equipment: 'Track/Open', difficulty: 'advanced', protocol: 'Build up then Fly.', movements: ['20m Build -> 30m Fly', '4 min Full Rest', 'Repeat 6-8x'], rounds: 7 },
                { id: 'hill-power', title: 'Hill Power Sprints', desc: 'Force Production.', equipment: 'Hill', difficulty: 'advanced', protocol: '100% Effort.', movements: ['10s Max Uphill', 'Slow walk down + 60s', 'Repeat 10x'], rounds: 10 },
                { id: 'plyo-speed', title: 'Plyometric Speed', desc: 'Explosive Power.', equipment: 'Box, Med Ball', difficulty: 'advanced', protocol: '60s Rest between moves.', movements: ['5 Box Jumps', '10 Med Ball Slams', '5 Broad Jumps', '1 15m Sprint', 'Repeat 4x'], rounds: 4 },

                // Speed Endurance
                { id: '60-60-flush', title: 'The 60/60 Flush', desc: 'Anaerobic Capacity.', equipment: 'Assault Runner', difficulty: 'advanced', protocol: '20 Mins Continuous.', movements: ['60s Hard Run', '60s Slow Walk', 'Repeat 10x'], rounds: 10 },
                { id: 'assault-400s', title: 'Assault 400s', desc: 'Pacing under duress.', equipment: 'Assault Runner', difficulty: 'advanced', protocol: 'Hard 400m.', movements: ['400m Run', '2 min Rest', 'Repeat 5x'], rounds: 5 },
                { id: 'descending-ladder', title: 'Descending Time Ladder', desc: 'Increasing Intensity.', equipment: 'Assault Runner', difficulty: 'advanced', protocol: 'Time drops, speed ups.', movements: ['90s Run/90s Rest', '75s/90s', '60s/90s', '45s/90s', '30s/90s', '15s/Done'], rounds: 6 },
                { id: 'calorie-pyramid', title: 'Calorie Crusher', desc: 'Output focus.', equipment: 'Assault Runner', difficulty: 'intermediate', protocol: 'Cals Hard / Walk Rest.', movements: ['15 Cal / 1:00', '25 Cal / 1:30', '35 Cal / 2:00', '25 Cal / 1:30', '15 Cal / Done'], rounds: 5 },
                { id: '200m-turnover', title: '200m Turnover', desc: 'Leg Speed.', equipment: 'Assault Runner', difficulty: 'advanced', protocol: 'Short rest.', movements: ['200m Sprint (90%)', '60s Rest', 'Repeat 8x'], rounds: 8 },
                { id: 'hard-start', title: 'Hard Start Intervals', desc: 'Lactate Clearing.', equipment: 'Assault Runner', difficulty: 'advanced', protocol: 'Sprint then Tempo.', movements: ['15s Sprint', '75s Tempo Run', '2 min Walk', 'Repeat 5x'], rounds: 5 },
                { id: 'gasser-ladder', title: 'The Gasser Ladder', desc: 'Change of Direction.', equipment: 'Field', difficulty: 'advanced', protocol: 'Full width & back x2.', movements: ['Full Gasser / 3m Rest', '3/4 Gasser / 2:30 Rest', '1/2 Gasser / 2m Rest', '1/4 Gasser / 1m Rest', 'Repeat Reverse'], rounds: 1 },
                { id: '200m-repeaters', title: '200m Interval Repeaters', desc: 'Track Conditioning.', equipment: 'Track', difficulty: 'intermediate', protocol: '90% Speed.', movements: ['200m Run', '90s Rest', 'Repeat 8-10x'], rounds: 9 },
                { id: '30-30-flush', title: 'The 30/30 Flush', desc: 'Recovery Training.', equipment: 'Track/Open', difficulty: 'intermediate', protocol: 'Continuous.', movements: ['30s Sprint', '30s Jog (Active)', 'Repeat 15-20 min'], rounds: 1 },

                // Aerobic / Threshold
                { id: '1k-threshold', title: '1k Threshold Repeats', desc: 'Comfortably Hard.', equipment: 'Assault Runner', difficulty: 'intermediate', protocol: 'Threshold pace.', movements: ['1000m Run', '2 min Walk', 'Repeat 4x'], rounds: 4 },
                { id: '20min-wattage', title: '20-Min Wattage Test', desc: 'Consistent Output.', equipment: 'Assault Runner', difficulty: 'advanced', protocol: 'Do not drop wattage.', movements: ['Run 20 Mins Continuous', 'Hold Target Wattage'], rounds: 1 },
                { id: 'distance-intervals', title: 'Distance Intervals', desc: 'Volume.', equipment: 'Assault Runner', difficulty: 'intermediate', protocol: 'Steady pace.', movements: ['800m Run', '3 min Jog', 'Repeat 5x'], rounds: 5 },
                { id: 'assault-fartlek', title: 'Assault Fartlek', desc: 'Speed Play.', equipment: 'Assault Runner', difficulty: 'intermediate', protocol: 'Unstructured.', movements: ['25 Mins Run', 'Random Surges 30-60s'], rounds: 1 },
                { id: 'overs-unders', title: 'Overs and Unders', desc: 'Lactate Shuttle.', equipment: 'Assault Runner', difficulty: 'advanced', protocol: '10 min blocks.', movements: ['10 min: 1m Fast / 1m Slow', '3 min Walk', 'Repeat Block'], rounds: 2 },
                { id: 'tempo-run', title: 'Tempo Run', desc: 'Lactate Threshold.', equipment: 'Open/Track', difficulty: 'intermediate', protocol: 'Comfortably Hard.', movements: ['10m Warmup', '20-30m Tempo', '10m Cooldown'], rounds: 1 },
                { id: 'long-intervals', title: 'Long Intervals', desc: 'VO2 Max.', equipment: 'Open/Track', difficulty: 'advanced', protocol: '5k Pace.', movements: ['4 min Hard', '3 min Jog', 'Repeat 4-5x'], rounds: 5 },
                { id: 'fartlek-outdoor', title: 'Fartlek Outdoor', desc: 'Speed Play.', equipment: 'Open', difficulty: 'beginner', protocol: 'Landmark Sprints.', movements: ['30-40 min Run', 'Random Sprints to landmarks'], rounds: 1 },

                // Hybrid Runner
                { id: 'assault-tabata', title: 'Assault Tabata', desc: 'Misery.', equipment: 'Assault Runner', difficulty: 'advanced', protocol: '20s Work / 10s Rest.', movements: ['Sprint 20s', 'Rest 10s (Stop belt)', 'Repeat 8x'], rounds: 8 },
                { id: 'legs-lungs', title: 'Legs & Lungs', desc: 'Pre-Fatigue.', equipment: 'Runner, DB', difficulty: 'advanced', protocol: 'Run on tired legs.', movements: ['20 Goblet Squats', '200m Sprint', '2 min Walk', 'Repeat 5x'], rounds: 5 },
                { id: 'fight-gone-bad-style', title: 'FGB Style Circuit', desc: 'Max Reps.', equipment: 'Runner, KB, DB', difficulty: 'advanced', protocol: '1 min each station.', movements: ['Min 1: Max Cal Run', 'Min 2: Max Swings', 'Min 3: Max Push Press', 'Min 4: Max Burpees', 'Min 5: Rest', 'Repeat 3x'], rounds: 3 },
                { id: 'grip-rip', title: 'The Grip & Rip', desc: 'HR Spike + Carry.', equipment: 'Runner, Heavy DB', difficulty: 'advanced', protocol: 'Run then Carry.', movements: ['400m Hard Run', '60s Heavy Farmer Carry', '2 min Rest', 'Repeat 4x'], rounds: 4 },
                { id: 'tabata-stack', title: 'The Tabata Stack', desc: 'Triple Tabata.', equipment: 'Open', difficulty: 'advanced', protocol: '3 Full Tabatas.', movements: ['Tabata Sprints (4m)', 'Rest 3m', 'Tabata Burpees (4m)', 'Rest 3m', 'Tabata High Knees (4m)'], rounds: 1 }
            ],
            tonic: [
                { id: 'plenty-of-nothing', title: 'I Got Plenty of Nothing!', desc: 'Foundational BW.', equipment: 'Floor', difficulty: 'beginner', protocol: 'Quality focus.', movements: ['Push-ups', 'Supermans', 'Hip Thrusts', 'Squats', 'Roll-ups', 'Walk'], rounds: 3 },
                { id: 'life-model', title: 'Life Model', desc: 'Crawl to rise.', equipment: 'Floor', difficulty: 'beginner', protocol: 'Restorative.', movements: ['Naked TGU', 'Kneeling Press', 'Bird Dog', 'OS Rocks'], rounds: 1 },
                { id: 'os-reset', title: 'OS Reset', desc: 'Nervous system.', equipment: 'Floor', difficulty: 'beginner', protocol: '20 min flow.', movements: ['Nods', 'Rocks', 'Crawl', 'Rolls'], rounds: 1 }
            ],
            ruck: [
                { id: 'ruck-15m', title: '1.5 Miles (Reset)', desc: 'Restorative.', equipment: 'Ruck', difficulty: 'beginner', protocol: 'Green light pace.', table: [{load:'10lb',time:'30:00'},{load:'45lb',time:'22:30'}], movements: ['1.5 Miles', 'Posture Focus'], rounds: 1 },
                { id: 'ruck-3k', title: '3.0 KM (Standard)', desc: 'Sweat & Recover.', equipment: 'Ruck', difficulty: 'intermediate', protocol: 'Zone 2.', table: [{load:'30lb',time:'32:00'}], movements: ['3.0 KM', 'Steady Pace'], rounds: 1 },
                { id: 'ruck-5k', title: '5.0 KM (Endurance)', desc: 'Training session.', equipment: 'Ruck', difficulty: 'advanced', protocol: 'Hydrate.', table: [{load:'30lb',time:'53:00'}], movements: ['5.0 KM', 'Grind'], rounds: 1 },
                { id: 'ruck-5m', title: '5.0 Miles (Long)', desc: 'Weekend Challenge.', equipment: 'Ruck', difficulty: 'advanced', protocol: '90+ mins.', table: [{load:'30lb',time:'1h 25m'}], movements: ['5.0 Miles', 'Durability'], rounds: 1 }
            ]
        };

        const REBUILD_PATHWAY = {
            overview: "12-week return-to-play. Reasonable, Repeatable, Doable.",
            weeks: [
                { week: 1, title: 'Week 1: Breath', context: 'Regulate system.', movements: ['Meditation', 'OS Nods', 'Walk'] },
                { week: 2, title: 'Week 2: Awakening', context: 'Range of motion.', movements: ['Hang 30s', 'Squat Hold 30s', 'Walk'] },
                { week: 3, title: 'Week 3: Patterning', context: 'Light load.', movements: ['Goblet Sq 1x5', 'Carry 20m', 'Walk'] },
                { week: 4, title: 'Week 4: Checkpoint', context: 'Integrity.', movements: ['Goblet Sq 2x5', 'Carry 40m', 'Walk'] },
                { week: 5, title: 'Week 5: Tension', context: '3x3 Rule.', movements: ['HK Press 3x3', 'Pull-up 3x3', 'Hip Thrust 3x10'] },
                { week: 6, title: 'Week 6: Stability', context: 'Fatigue mgmt.', movements: ['HK Press 3x3', 'Swing 3x10', 'Carry'] },
                { week: 7, title: 'Week 7: Volume', context: 'Shift to 2x5.', movements: ['HK Press 2x5', 'Pull-up 2x5', 'Swing 2x15'] },
                { week: 8, title: 'Week 8: Capacity', context: 'Test strength.', movements: ['HK Press 2x5+', 'Goblet 2x10', 'Carry'] },
                { week: 9, title: 'Week 9: Integration', context: 'Perfect Workout.', movements: ['[A] Press+Hang', '[B] Sq+Swing+Carry'] },
                { week: 10, title: 'Week 10: Density', context: 'Min Rest.', movements: ['[A] 3 Rnds', '[B] Higher Reps'] },
                { week: 11, title: 'Week 11: Load', context: 'Heavier.', movements: ['[A] Heavy Press', '[B] Heavy Swing'] },
                { week: 12, title: 'Week 12: Grad', context: 'Ready.', movements: ['[A] 3 Rnds', '[B] 2 Rnds'] }
            ]
        };

        let state = { currentTab: 'home', activeWorkout: null, activeRebuildWeek: null, warmupActive: false, checklist: {}, timer: 0, timerRunning: false, history: [], chatHistory: [], apiKey: localStorage.getItem(API_KEY_STORAGE) || '', ...loadState() };
        let timerInterval;

        function loadState() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch(e) { return {}; } }
        function saveState() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e) {} }

        const Icons = {
            Home: '<i data-lucide="home" class="w-5 h-5"></i>', Dumbbell: '<i data-lucide="dumbbell" class="w-5 h-5"></i>', Zap: '<i data-lucide="zap" class="w-5 h-5"></i>', Activity: '<i data-lucide="activity" class="w-5 h-5"></i>', Shuffle: '<i data-lucide="shuffle" class="w-6 h-6"></i>', ChevronLeft: '<i data-lucide="chevron-left" class="w-6 h-6"></i>', Check: '<i data-lucide="check" class="w-4 h-4 text-white hidden"></i>', Info: '<i data-lucide="info" class="w-5 h-5"></i>', Leaf: '<i data-lucide="leaf" class="w-5 h-5"></i>', Dices: '<i data-lucide="dices" class="w-8 h-8"></i>', Flame: '<i data-lucide="flame" class="w-5 h-5"></i>', X: '<i data-lucide="x" class="w-6 h-6"></i>', Calendar: '<i data-lucide="calendar" class="w-5 h-5"></i>', History: '<i data-lucide="clock" class="w-5 h-5"></i>', Footprints: '<i data-lucide="footprints" class="w-4 h-4"></i>', Trash: '<i data-lucide="trash-2" class="w-4 h-4"></i>', Save: '<i data-lucide="save" class="w-4 h-4"></i>', Timer: '<i data-lucide="timer" class="w-6 h-6"></i>', Sparkles: '<i data-lucide="sparkles" class="w-5 h-5"></i>', Send: '<i data-lucide="send" class="w-5 h-5"></i>', Settings: '<i data-lucide="settings" class="w-5 h-5"></i>', Lock: '<i data-lucide="lock" class="w-4 h-4"></i>', Repeat: '<i data-lucide="repeat" class="w-4 h-4"></i>', Gauge: '<i data-lucide="gauge" class="w-4 h-4"></i>'
        };

        function getDifficultyIcon(diff) { return diff === 'beginner' ? '<span class="inline-block w-2 h-2 rounded-full bg-emerald-500"></span>' : diff === 'intermediate' ? '<span class="inline-block w-2 h-2 rounded-full bg-yellow-500"></span>' : '<span class="inline-block w-2 h-2 rounded-full bg-red-600"></span>'; }
        function getIconForTab(tab) { if(tab==='grind') return Icons.Dumbbell; if(tab==='ballistic') return Icons.Zap; if(tab==='hybrid') return Icons.Activity; if(tab==='rebuild') return Icons.Leaf; if(tab==='tonic') return Icons.Tonic; if(tab==='ruck') return Icons.Footprints; if(tab==='emom') return Icons.Repeat; if(tab==='conditioning') return Icons.Gauge; if(tab==='history') return Icons.History; return Icons.Dumbbell; }

        function getWorkoutCategory(id) {
            for (const [cat, list] of Object.entries(WORKOUTS)) { if (list.find(w => w.id === id)) return cat.charAt(0).toUpperCase() + cat.slice(1); }
            if(id.startsWith('rebuild-week-')) return 'Rebuild'; return 'Unknown';
        }

        // --- 4. RENDER ---
        function render() {
            const app = document.getElementById('app');
            let html = `
                <div class="pt-safe-top bg-zinc-900 border-b border-zinc-800 sticky top-0 z-50">
                    <div class="h-14 flex items-center justify-between px-4">
                        ${state.activeWorkout ? `<button onclick="APP.exitWorkout()" class="p-2 -ml-2 text-zinc-400 hover:text-white">${Icons.ChevronLeft}</button>` : `<button onclick="APP.toggleWarmup()" class="p-2 -ml-2 text-zinc-400 hover:text-red-500">${Icons.Flame}</button>`}
                        <h1 class="text-lg font-bold tracking-tight text-white uppercase italic">The Iron Garage</h1>
                        <button onclick="APP.showInventory()" class="p-2 -mr-2 text-zinc-400 hover:text-white">${Icons.Info}</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto overflow-x-hidden hide-scrollbar pb-safe-bottom bg-zinc-950 relative">`;
            
            if (state.warmupActive) html += renderWarmup();
            else if (state.activeWorkout) html += renderActiveWorkout();
            else html += renderDashboard();
            
            if(state.activeWorkout) html += renderFloatingTimer();
            
            html += `</div>`;
            app.innerHTML = html;
            lucide.createIcons();
            const chatContainer = document.getElementById('chat-container');
            if(chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function renderFloatingTimer() {
            const mins = Math.floor(state.timer / 60).toString().padStart(2, '0');
            const secs = (state.timer % 60).toString().padStart(2, '0');
            return `<button onclick="APP.toggleTimer()" class="floating-timer bg-zinc-800 border border-zinc-700 text-white rounded-full h-14 pl-4 pr-5 flex items-center gap-2 shadow-xl shadow-black/50 active:scale-95 transition-transform"><span class="${state.timerRunning ? 'text-red-500 animate-pulse' : 'text-zinc-400'}">${Icons.Timer}</span><span class="font-mono text-lg font-bold">${mins}:${secs}</span></button>`;
        }

        function renderWarmup() {
            return `<div class="p-6 space-y-6"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-black text-white uppercase">Daily Warm-up</h2><button onclick="APP.toggleWarmup()" class="text-zinc-400 hover:text-white">${Icons.X}</button></div><div class="space-y-4">${WARMUP_ROUTINE.map(s=>`<div class="bg-zinc-900 border border-zinc-800 p-4 rounded-xl"><h3 class="text-red-500 font-bold uppercase text-sm mb-1">${s.title}</h3><p class="text-zinc-300 text-sm leading-snug">${s.desc}</p></div>`).join('')}</div><button onclick="APP.toggleWarmup()" class="w-full bg-zinc-100 text-zinc-900 font-bold py-4 rounded-xl mt-8">Ready to Lift</button></div>`;
        }

        function renderDashboard() {
            const tabs = ['home','grind','ballistic','hybrid','emom','conditioning','tonic','ruck','rebuild','history'];
            let nav = `<div class="flex border-b border-zinc-800 bg-zinc-900 sticky top-0 z-40 overflow-x-auto hide-scrollbar">`;
            tabs.forEach(t => {
                let cls = state.currentTab===t ? (t==='rebuild'?'tab-active-rebuild':t==='tonic'?'tab-active-tonic':t==='ruck'?'tab-active-ruck':t==='emom'?'tab-active-emom':t==='conditioning'?'tab-active-cond':t==='history'?'tab-active-history':'tab-active') : 'tab-inactive';
                let label = t;
                if(t==='conditioning') label = 'Cond.';
                nav += `<button onclick="APP.switchTab('${t}')" class="flex-1 py-4 ${t==='home'?'flex justify-center min-w-[60px]':'text-xs font-bold uppercase tracking-wider text-center min-w-[80px]'} ${cls}">${t==='home'?Icons.Home:label}</button>`;
            });
            nav += `</div>`;

            if(state.currentTab==='home') return nav + renderHome();
            if(state.currentTab==='rebuild') return nav + renderRebuildHub();
            if(state.currentTab==='history') return nav + renderHistory();

            let content = '';
            if(state.currentTab==='ruck') content += `<div class="p-4"><div class="bg-zinc-900 border border-amber-900/30 p-4 rounded-2xl mb-4 text-sm text-zinc-400"><strong class="text-amber-500 block mb-1">Ruck Rules</strong>Don't Run. Posture First. Talk Test.</div>`;
            else if(state.currentTab!=='tonic') content += `<div class="px-4 pt-6 pb-2"><button onclick="APP.randomizeInTab('${state.currentTab}')" class="w-full bg-gradient-to-r from-red-600 to-red-700 text-white rounded-xl py-4 shadow-lg flex items-center justify-center gap-2">${Icons.Shuffle}<span class="font-bold uppercase">Roll Dice: ${state.currentTab}</span></button></div>`;
            
            content += `<div class="p-4 space-y-3">`;
            WORKOUTS[state.currentTab].forEach(w => {
                content += `<div onclick="APP.selectWorkout('${w.id}')" class="bg-zinc-900 border border-zinc-800 rounded-xl p-4 cursor-pointer relative group"><div class="absolute top-0 right-0 p-2">${getDifficultyIcon(w.difficulty)}</div><h3 class="text-white font-bold text-lg">${w.title}</h3><p class="text-zinc-400 text-sm mb-2">${w.desc}</p><div class="flex items-center gap-2 text-xs text-zinc-500">${getIconForTab(state.currentTab)}<span>${w.equipment}</span></div></div>`;
            });
            content += `</div>`;
            if(state.currentTab==='ruck') content += `</div>`;
            return nav + content;
        }

        function renderRebuildHub() {
            if(state.activeRebuildWeek!==null) {
                const w = REBUILD_PATHWAY.weeks.find(x=>x.week===state.activeRebuildWeek);
                return `<div class="p-6"><button onclick="APP.clearRebuildWeek()" class="flex items-center text-emerald-500 text-sm font-bold mb-4">${Icons.ChevronLeft} Roadmap</button><div class="bg-zinc-900 border border-emerald-900/30 p-6 rounded-2xl mb-6"><h2 class="text-xl font-bold text-white">${w.title}</h2><p class="text-zinc-300 text-sm mt-2">${w.context}</p></div><div class="bg-zinc-900 border border-zinc-800 rounded-xl p-4"><ul class="space-y-3">${w.movements.map(m=>`<li class="flex gap-3 text-zinc-200 text-sm"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-2 shrink-0"></span>${m}</li>`).join('')}</ul><button onclick="APP.startRebuildSession(${w.week})" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg mt-6 uppercase text-sm">Start</button></div></div>`;
            }
            return `<div class="p-6 space-y-6"><div class="bg-zinc-900 p-5 rounded-2xl border border-zinc-800"><h2 class="text-xl font-bold text-white mb-2 flex gap-2"><span class="text-emerald-500">${Icons.Leaf}</span>Mission Brief</h2><p class="text-zinc-400 text-sm">${REBUILD_PATHWAY.overview}</p></div><div class="grid grid-cols-4 gap-2">${REBUILD_PATHWAY.weeks.map(w=>`<button onclick="APP.setRebuildWeek(${w.week})" class="aspect-square bg-zinc-900 border border-zinc-800 rounded-xl flex flex-col items-center justify-center hover:border-emerald-500"><span class="text-[10px] text-zinc-500">WK</span><span class="text-xl font-bold text-white">${w.week}</span></button>`).join('')}</div></div>`;
        }

        function renderHome() {
            const last = state.history.length > 0 ? state.history[state.history.length-1] : null;
            let chatInterface = '';
            if (state.apiKey) {
                chatInterface = `<div class="flex items-center gap-2 mb-3"><div class="text-red-500 bg-red-900/20 p-2 rounded-lg">${Icons.Sparkles}</div><h3 class="text-white font-bold text-sm uppercase tracking-wide">Ask The Trainer</h3></div><div id="chat-container" class="bg-zinc-950 rounded-xl p-3 h-48 overflow-y-auto mb-3 flex flex-col gap-2 border border-zinc-800/50">${state.chatHistory.length === 0 ? '<div class="text-zinc-500 text-xs italic text-center mt-10">Ask about injuries, subs, or protocol details...</div>' : state.chatHistory.map(msg => `<div class="chat-bubble ${msg.role === 'user' ? 'chat-user' : 'chat-ai'}">${msg.text}</div>`).join('')}</div><div class="flex gap-2"><input type="text" id="chat-input" class="flex-1 bg-zinc-800 border border-zinc-700 rounded-lg px-3 text-sm text-white focus:outline-none focus:border-red-500" placeholder="Question?"><button onclick="APP.sendMessage()" class="bg-red-600 text-white p-2 rounded-lg hover:bg-red-500">${Icons.Send}</button></div><div class="mt-2 text-right"><button onclick="APP.clearApiKey()" class="text-[10px] text-zinc-600 underline">Clear API Key</button></div>`;
            } else {
                chatInterface = `<div class="flex items-center gap-2 mb-3"><div class="text-zinc-500 bg-zinc-800 p-2 rounded-lg">${Icons.Lock}</div><h3 class="text-zinc-400 font-bold text-sm uppercase tracking-wide">AI Trainer Locked</h3></div><p class="text-xs text-zinc-500 mb-3">Enter your Google Gemini API Key to enable the AI coach. Keys are stored locally on your device only.</p><div class="flex gap-2"><input type="password" id="api-key-input" class="flex-1 bg-zinc-950 border border-zinc-800 rounded-lg px-3 text-sm text-white placeholder-zinc-700 focus:outline-none focus:border-red-500" placeholder="Paste API Key"><button onclick="APP.saveApiKey()" class="bg-zinc-800 text-zinc-200 px-4 py-2 rounded-lg text-xs font-bold hover:bg-zinc-700">Save</button></div><div class="mt-2"><a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[10px] text-red-500 hover:text-red-400">Get a Free Key &rarr;</a></div>`;
            }

            return `<div class="p-6 flex flex-col gap-6 min-h-[80vh]"><div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-8 flex flex-col items-center text-center space-y-5 shadow-xl mt-4"><div class="bg-red-900/10 p-5 rounded-full border border-red-900/30 text-red-500">${Icons.Dices}</div><h2 class="text-2xl font-black text-white uppercase italic">Garage Roulette</h2><button onclick="APP.randomizeGlobal()" class="w-full bg-red-600 text-white font-bold py-4 rounded-xl uppercase shadow-lg gap-2 flex items-center justify-center">${Icons.Shuffle} Randomize All</button><div class="flex gap-4 mt-2"><button onclick="APP.wipeData()" class="text-[10px] text-zinc-600 hover:text-red-500 flex gap-1">${Icons.Trash} Burn</button><button onclick="APP.exportData()" class="text-[10px] text-zinc-600 hover:text-white flex gap-1">${Icons.Save} Backup</button></div>${last?`<div class="text-xs text-zinc-500 mt-4 border-t border-zinc-800 pt-2 w-full">Last: ${last.name} (${new Date(last.date).toLocaleDateString()})</div>`:''}</div><div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-4 flex flex-col shadow-lg">${chatInterface}</div><div class="text-[10px] text-zinc-700 font-mono text-center">Build: ${APP_BUILD_DATE}<br>Philosophy: Dan John</div></div>`;
        }

        function renderHistory() {
            if(!state.history.length) return `<div class="p-10 text-center text-zinc-500">No workouts completed yet.</div>`;
            return `<div class="p-4 space-y-2"><div class="flex justify-between items-center px-2 mb-2"><h3 class="text-xs font-bold text-zinc-500 uppercase">Log</h3><button onclick="APP.clearHistory()" class="text-[10px] text-red-500">Clear</button></div>${state.history.slice().reverse().map(h=>`<div class="bg-zinc-900 border border-zinc-800 p-3 rounded-lg flex justify-between items-center"><span class="text-white font-bold text-sm">${h.name}</span><span class="text-xs text-zinc-500">${new Date(h.date).toLocaleDateString()}</span></div>`).join('')}</div>`;
        }

        function renderActiveWorkout() {
            const w = state.activeWorkout;
            let theme = 'bg-red-900/30 text-red-500 border-red-900/50';
            let check = 'checkbox-wrapper';
            if (w.id.includes('rebuild')) { theme = 'bg-emerald-900/30 text-emerald-500 border-emerald-900/50'; check = 'checkbox-wrapper-rebuild'; }
            else if (state.currentTab === 'tonic') { theme = 'bg-blue-900/30 text-blue-500 border-blue-900/50'; check = 'checkbox-wrapper-tonic'; }
            else if (state.currentTab === 'ruck') { theme = 'bg-amber-900/30 text-amber-500 border-amber-900/50'; check = 'checkbox-wrapper-ruck'; }
            else if (state.currentTab === 'emom') { theme = 'bg-cyan-900/30 text-cyan-500 border-cyan-900/50'; check = 'checkbox-wrapper-emom'; }
            else if (state.currentTab === 'conditioning') { theme = 'bg-rose-900/30 text-rose-500 border-rose-900/50'; check = 'checkbox-wrapper-cond'; }

            return `<div class="min-h-full pb-24"><div class="px-6 pt-8 pb-6 bg-zinc-900 border-b border-zinc-800"><div class="flex justify-between items-start mb-3"><div class="inline-block px-2 py-1 rounded ${theme} text-xs font-bold uppercase tracking-wider border">${getWorkoutCategory(w.id)}</div>${w.difficulty ? `<div class="bg-zinc-800 px-2 py-1 rounded border border-zinc-700 text-xs text-zinc-300 capitalize flex items-center gap-1">${getDifficultyIcon(w.difficulty)} ${w.difficulty}</div>` : ''}</div><h2 class="text-3xl font-black text-white mb-2 leading-none">${w.title}</h2><p class="text-zinc-400 text-sm">${w.desc}</p></div><div class="p-6 space-y-6">${w.equipment ? `<div class="bg-zinc-900/50 rounded-lg p-4 border border-zinc-800"><h4 class="text-xs font-bold text-zinc-500 uppercase tracking-wider mb-2">Gear Required</h4><p class="text-zinc-300 text-sm font-medium">${w.equipment}</p></div>` : ''}${w.table ? `<div class="bg-zinc-900/50 rounded-lg p-4 border border-zinc-800 overflow-x-auto"><table class="w-full text-left text-sm text-zinc-300"><thead><tr class="border-b border-zinc-700"><th class="py-2">Load</th><th class="py-2">Beginner</th><th class="py-2">Mod</th><th class="py-2">Adv</th></tr></thead><tbody>${w.table.map(r=>`<tr class="border-b border-zinc-800 last:border-0"><td class="py-2 font-bold text-white">${r.load}</td><td class="py-2 text-emerald-500">${r.beginner}</td><td class="py-2 text-yellow-500">${r.moderate}</td><td class="py-2 text-red-500">${r.advanced}</td></tr>`).join('')}</tbody></table></div>` : ''}<div class="bg-zinc-900/50 rounded-lg p-4 border border-zinc-800"><h4 class="text-xs font-bold text-zinc-500 uppercase tracking-wider mb-2">Detailed Protocol</h4>${w.protocol ? `<p class="text-zinc-300 text-sm mb-4 italic border-l-2 border-zinc-700 pl-3">${w.protocol}</p>` : ''}<ul class="space-y-3">${w.movements.map(m=>`<li class="flex items-start gap-3 text-zinc-200 text-sm"><span class="w-1.5 h-1.5 rounded-full ${w.id.includes('rebuild')?'bg-emerald-500':'bg-red-600'} mt-2 shrink-0"></span><span class="leading-relaxed">${m}</span></li>`).join('')}</ul></div><div><div class="flex justify-between items-end mb-4"><h4 class="text-sm font-bold text-white uppercase tracking-wider">Round Tracker</h4></div><div class="grid grid-cols-5 gap-2">${Array.from({length:w.rounds}).map((_,i)=>`<label class="${check} cursor-pointer relative"><input type="checkbox" class="opacity-0 absolute w-full h-full z-10" ${state.checklist[i]?'checked':''} onchange="APP.toggleRound(${i})"><div class="h-12 rounded bg-zinc-800 border-2 border-zinc-700 flex items-center justify-center transition-all"><span class="text-sm font-bold text-zinc-500 ${state.checklist[i]?'hidden':'block'}">${i+1}</span>${Icons.Check}</div></label>`).join('')}<button onclick="APP.addRound()" class="h-12 rounded bg-zinc-900 border border-dashed border-zinc-700 flex items-center justify-center text-zinc-500 hover:text-white hover:border-zinc-500 active:scale-95 transition-all"><span class="text-xl font-bold">+</span></button></div></div><div class="pt-8"><button onclick="APP.completeWorkout()" class="w-full py-4 bg-zinc-100 text-zinc-900 font-bold uppercase rounded-xl active:scale-[0.98] transition-transform">Finish Session</button></div></div></div>`;
        }

        // --- 5. LOGIC & API ---
        window.APP = {
            switchTab: (t) => { state.currentTab = t; saveState(); render(); },
            toggleWarmup: () => { state.warmupActive = !state.warmupActive; render(); },
            exitWorkout: () => { clearInterval(timerInterval); state.activeWorkout = null; state.checklist = {}; state.timer = 0; state.timerRunning = false; saveState(); render(); },
            completeWorkout: () => { if(confirm('Finish workout?')) { state.history.push({ name: state.activeWorkout.title, date: new Date().toISOString() }); APP.exitWorkout(); } },
            toggleRound: (i) => { state.checklist[i] = !state.checklist[i]; saveState(); render(); },
            addRound: () => { if(state.activeWorkout) { state.activeWorkout.rounds++; saveState(); render(); } },
            toggleTimer: () => { state.timerRunning = !state.timerRunning; if(state.timerRunning) { timerInterval = setInterval(() => { state.timer++; renderFloatingTimerUI(); }, 1000); } else { clearInterval(timerInterval); renderFloatingTimerUI(); } render(); },
            setRebuildWeek: (wk) => { state.activeRebuildWeek = wk; saveState(); render(); },
            clearRebuildWeek: () => { state.activeRebuildWeek = null; saveState(); render(); },
            startRebuildSession: (wk) => { const w = REBUILD_PATHWAY.weeks.find(x=>x.week===wk); state.activeWorkout = { id: `rebuild-${wk}`, title: w.title, desc: w.context, equipment: 'Bodyweight/Light', difficulty: 'beginner', movements: w.movements, rounds: 1 }; state.checklist = {}; saveState(); render(); },
            selectWorkout: (id) => { let w = null; for(const k in WORKOUTS) { w = WORKOUTS[k].find(x=>x.id===id); if(w) break; } if(w) { state.activeWorkout = w; state.checklist = {}; state.warmupActive = false; saveState(); render(); } },
            randomizeInTab: (tab) => { const list = WORKOUTS[tab]; if(list) APP.selectWorkout(list[Math.floor(Math.random()*list.length)].id); },
            randomizeGlobal: () => { const all = [WORKOUTS.grind, WORKOUTS.ballistic, WORKOUTS.hybrid, WORKOUTS.conditioning].flat(); APP.selectWorkout(all[Math.floor(Math.random()*all.length)].id); },
            showInventory: () => alert(`INVENTORY:\n• KBs (Pairs): ${INVENTORY.kbs.pairs.join('kg, ')}kg\n• KBs (Singles): ${INVENTORY.kbs.singles.join('kg, ')}kg\n• Barbell\n• ${INVENTORY.machines.join('\n• ')}`),
            wipeData: () => { if(confirm('Permanently delete all data?')) { localStorage.removeItem(STORAGE_KEY); localStorage.removeItem(API_KEY_STORAGE); location.reload(); } },
            exportData: () => { navigator.clipboard.writeText(JSON.stringify(state)).then(()=>alert('Data copied to clipboard')); },
            clearHistory: () => { if(confirm('Clear history?')) { state.history = []; saveState(); render(); } },
            saveApiKey: () => { const input = document.getElementById('api-key-input'); if(input && input.value) { state.apiKey = input.value.trim(); localStorage.setItem(API_KEY_STORAGE, state.apiKey); saveState(); render(); } },
            clearApiKey: () => { state.apiKey = ''; localStorage.removeItem(API_KEY_STORAGE); saveState(); render(); },
            sendMessage: async () => {
                const input = document.getElementById('chat-input'); const text = input.value.trim(); if(!text) return;
                state.chatHistory.push({role: 'user', text: text}); render(); input.value = '';
                state.chatHistory.push({role: 'ai', text: 'Thinking...'}); render();
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: `You are an expert strength coach following the philosophy of Dan John (Easy Strength, Armor Building). Context: ${KNOWLEDGE_BASE}. User Inventory: ${JSON.stringify(INVENTORY)}. User Query: ${text}. Keep answer short (under 50 words), actionable, and "tough love" style.` }] }] })
                    });
                    const data = await response.json();
                    state.chatHistory.pop(); state.chatHistory.push({role: 'ai', text: data.candidates[0].content.parts[0].text});
                    saveState(); render();
                } catch (e) { state.chatHistory.pop(); state.chatHistory.push({role: 'ai', text: "Error. Check API Key or connection."}); render(); }
            }
        };

        function renderFloatingTimerUI() {
            const btn = document.querySelector('.floating-timer');
            if(btn) { const mins = Math.floor(state.timer/60).toString().padStart(2,'0'); const secs = (state.timer%60).toString().padStart(2,'0'); btn.innerHTML = `<span class="${state.timerRunning?'text-red-500 animate-pulse':'text-zinc-400'}">${Icons.Timer}</span><span class="font-mono text-lg font-bold">${mins}:${secs}</span>`; }
        }

        render();
    })();
    </script>
</body>
</html>
